<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Plan — Scaffold</title>
<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a18;
    --cream: #f8f5f0;
    --warm-white: #fdfcfa;
    --sage: #4a6741;
    --sage-light: #e8ede6;
    --sage-dark: #3a5233;
    --terra: #c4652a;
    --terra-light: #f5ece5;
    --muted: #6b6860;
    --border: #d9d4cc;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Sans', sans-serif;
    color: var(--ink);
    background: var(--warm-white);
    line-height: 1.7;
    -webkit-font-smoothing: antialiased;
  }

  /* ---- PROGRESS BAR ---- */
  .progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 3px;
    background: var(--sage);
    z-index: 200;
    width: 0%;
    transition: width 0.15s linear;
  }

  /* ---- TOP BAR ---- */
  .topbar {
    position: fixed;
    top: 3px;
    width: 100%;
    z-index: 100;
    background: rgba(253, 252, 250, 0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    height: 49px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .topbar-logo {
    font-family: 'Newsreader', serif;
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--ink);
    text-decoration: none;
    letter-spacing: -0.02em;
  }
  .topbar-logo span { color: var(--sage); }

  .topbar-right { display: flex; align-items: center; gap: 1.25rem; }

  .topbar-cta {
    font-size: 0.78rem;
    font-weight: 600;
    color: white;
    background: var(--sage);
    padding: 0.35rem 0.9rem;
    border-radius: 5px;
    text-decoration: none;
    transition: background 0.2s;
  }
  .topbar-cta:hover { background: var(--sage-dark); }

  .topbar-link {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.2s;
  }
  .topbar-link:hover { color: var(--ink); }

  .sample-bar {
    position: fixed;
    top: 52px;
    width: 100%;
    z-index: 99;
    background: var(--sage-light);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    height: 38px;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.78rem;
    font-family: 'DM Sans', sans-serif;
  }

  .sample-bar.visible { display: flex; }

  .sample-bar-label {
    color: var(--muted);
    font-weight: 500;
    margin-right: 0.25rem;
  }

  .sample-bar a {
    color: var(--sage-dark);
    text-decoration: none;
    font-weight: 600;
    padding: 0.25rem 0.65rem;
    border-radius: 4px;
    transition: background 0.15s, color 0.15s;
  }

  .sample-bar a:hover { background: rgba(74, 103, 65, 0.12); }
  .sample-bar a.active { background: var(--sage); color: white; }

  .sample-bar-sep { color: var(--border); }

  /* Shift content down when sample bar is visible */
  body.has-sample-bar .hero { margin-top: 38px; }
  body.has-sample-bar .sidebar-nav { top: 90px; }
  body.has-sample-bar .strategy-body h1,
  body.has-sample-bar .strategy-body h2 { scroll-margin-top: 118px; }

  /* ---- HERO ---- */
  .hero {
    background: var(--cream);
    color: var(--ink);
    padding: 6.5rem 2rem 3rem;
    border-bottom: 1px solid var(--border);
  }

  .hero-inner {
    max-width: 780px;
    margin: 0 auto;
  }

  .hero-badge {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--sage);
    margin-bottom: 1rem;
  }

  .hero h1 {
    font-family: 'Newsreader', serif;
    font-size: clamp(2rem, 4.5vw, 2.8rem);
    font-weight: 400;
    line-height: 1.1;
    letter-spacing: -0.03em;
    margin-bottom: 0.75rem;
  }

  .hero-meta {
    font-size: 0.88rem;
    color: var(--muted);
  }

  /* ---- TABLE OF CONTENTS ---- */
  .toc {
    max-width: 780px;
    margin: 0 auto;
    padding: 1.75rem 2rem;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-top: 2rem;
  }

  .toc-title {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--sage);
    margin-bottom: 1rem;
    padding-bottom: 0.6rem;
    border-bottom: 1px solid var(--border);
  }

  .toc-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0 2rem;
  }

  .toc-list {
    list-style: none;
    margin-bottom: 0;
  }

  .toc-list li {
    margin-bottom: 0.2rem;
  }

  .toc-list a {
    font-size: 0.82rem;
    color: var(--muted);
    text-decoration: none;
    padding: 0.3rem 0;
    display: block;
    transition: color 0.2s;
  }
  .toc-list a:hover { color: var(--sage); }

  .toc-list .toc-h1 a {
    font-weight: 600;
    color: var(--ink);
    font-size: 0.85rem;
    margin-top: 0.6rem;
  }
  .toc-list .toc-h1:first-child a { margin-top: 0; }
  .toc-list .toc-h1 a:hover { color: var(--sage); }

  .toc-list .toc-h2 { padding-left: 0.75rem; }
  .toc-list .toc-h2 a { font-size: 0.78rem; }

  /* ---- STRATEGY BODY ---- */
  .strategy-body {
    max-width: 780px;
    margin: 0 auto;
    padding: 2.5rem 2rem 4rem;
  }

  .strategy-body h1 {
    font-family: 'Newsreader', serif;
    font-size: 1.9rem;
    font-weight: 500;
    letter-spacing: -0.02em;
    margin-top: 3.5rem;
    margin-bottom: 0.25rem;
    padding: 2.5rem 0 0;
    border-top: 3px solid var(--sage);
    scroll-margin-top: 80px;
    text-wrap: balance;
  }

  .strategy-body h1:first-child { margin-top: 0; padding-top: 0; border-top: none; }

  .section-rule {
    width: 36px;
    height: 3px;
    background: var(--sage);
    border-radius: 2px;
    margin-bottom: 1.25rem;
  }

  .strategy-body h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.45rem;
    font-weight: 500;
    letter-spacing: -0.02em;
    margin-top: 2rem;
    margin-bottom: 0.4rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    scroll-margin-top: 80px;
    text-wrap: balance;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .strategy-body h2::after {
    content: '▾';
    font-size: 0.85rem;
    color: var(--muted);
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .strategy-body h2.collapsed::after {
    transform: rotate(-90deg);
  }

  .strategy-body h2:hover::after { color: var(--sage); }

  .section-content {
    overflow: hidden;
    opacity: 1;
  }

  .section-content.collapsible {
    transition: max-height 0.35s ease, opacity 0.25s ease;
  }

  .section-content.collapsed {
    max-height: 0 !important;
    opacity: 0;
    margin: 0;
  }

  .strategy-body h2:first-child { margin-top: 0; padding-top: 0; border-top: none; }

  .strategy-body h3 {
    font-size: 1.05rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.5rem;
    color: var(--sage-dark);
    scroll-margin-top: 80px;
  }

  .strategy-body h4 {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--sage);
    margin-top: 1.75rem;
    margin-bottom: 0.75rem;
  }

  .strategy-body p {
    margin-bottom: 1.1rem;
    color: #3d3d3a;
    font-size: 0.92rem;
  }

  .strategy-body strong { font-weight: 600; color: var(--ink); }
  .strategy-body em { font-style: italic; }

  .strategy-body ul, .strategy-body ol {
    padding-left: 0;
    margin-bottom: 1.1rem;
    list-style: none;
  }

  .strategy-body ul > li {
    margin-bottom: 0.5rem;
    font-size: 0.92rem;
    color: #3d3d3a;
    padding-left: 1.25rem;
    position: relative;
  }

  .strategy-body ul > li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.55em;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--sage);
  }

  .strategy-body ol {
    counter-reset: ol-counter;
  }

  .strategy-body ol > li {
    margin-bottom: 0.5rem;
    font-size: 0.92rem;
    color: #3d3d3a;
    padding-left: 2rem;
    position: relative;
    counter-increment: ol-counter;
  }

  .strategy-body ol > li::before {
    content: counter(ol-counter);
    position: absolute;
    left: 0;
    top: 0.1em;
    width: 1.4rem;
    height: 1.4rem;
    border-radius: 50%;
    background: var(--sage-light);
    color: var(--sage-dark);
    font-size: 0.72rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Nested lists */
  .strategy-body li ul, .strategy-body li ol {
    margin-top: 0.4rem;
    margin-bottom: 0;
  }

  .strategy-body hr {
    border: none;
    border-top: 2px solid var(--sage-light);
    margin: 2rem 0;
  }

  /* Hide trailing <hr> inside collapsible sections — the h2 border-top already provides separation */
  .section-content > hr:last-child {
    display: none;
  }

  /* ---- CALLOUT BOXES (blockquotes) ---- */
  .strategy-body blockquote {
    font-family: 'DM Sans', sans-serif;
    font-style: normal;
    font-size: 0.88rem;
    border-left: 3px solid var(--sage);
    background: var(--sage-light);
    padding: 1.1rem 1.5rem;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
    color: #3d3d3a;
    line-height: 1.6;
  }

  .strategy-body blockquote strong {
    color: var(--sage-dark);
  }

  /* ---- SCHOOL CARDS (per-school detail sections) ---- */
  .school-card {
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1.25rem 0;
  }

  .school-card h3 {
    margin-top: 0;
    color: var(--ink);
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.75rem;
  }

  /* Tables */
  .strategy-body .table-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 1.25rem 0 1.75rem;
  }

  .strategy-body table {
    width: 100%;
    min-width: 500px;
    border-collapse: collapse;
    font-size: 0.82rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .strategy-body thead {
  }

  .strategy-body th {
    text-align: left;
    font-weight: 600;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: white;
    padding: 0.65rem 0.75rem;
    border-bottom: 2px solid var(--sage-dark);
    background: var(--sage);
    white-space: nowrap;
  }

  .strategy-body td {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid #eae7e2;
    color: #3d3d3a;
    vertical-align: top;
  }

  .strategy-body tbody tr:nth-child(even) td {
    background: rgba(248, 245, 240, 0.5);
  }

  .strategy-body tr:hover td { background: rgba(232,237,230,0.3); }

  /* Tier badges in table cells */
  .tier-badge {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    white-space: nowrap;
  }
  .tier-reach { background: var(--terra-light); color: var(--terra); }
  .tier-target { background: var(--sage-light); color: var(--sage-dark); }
  .tier-safety { background: var(--cream); color: var(--muted); border: 1px solid var(--border); }

  /* Financial risk badges */
  .risk-badge {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    white-space: nowrap;
  }
  .risk-very-low { background: #e8f5e9; color: #2e7d32; }
  .risk-low { background: #e8f5e9; color: #2e7d32; }
  .risk-moderate { background: #fff8e1; color: #f57f17; }
  .risk-high { background: #fce4ec; color: #c62828; }
  .risk-very-high { background: #f8d7da; color: #8b0000; }

  /* First table (exec summary) gets extra prominence */
  .strategy-body table.exec-summary {
    border: 2px solid var(--sage);
    font-size: 0.85rem;
  }
  .strategy-body table.exec-summary th {
    font-size: 0.7rem;
    padding: 0.75rem;
  }
  .strategy-body table.exec-summary td {
    padding: 0.75rem;
  }

  /* Activity status badges */
  .activity-current {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.45rem;
    border-radius: 3px;
    background: #e8f5e9;
    color: #2e7d32;
    margin-right: 0.25rem;
  }
  .activity-target {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.45rem;
    border-radius: 3px;
    background: #e3f2fd;
    color: #1565c0;
    margin-right: 0.25rem;
  }
  .activity-aspirational {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.45rem;
    border-radius: 3px;
    background: var(--terra-light);
    color: var(--terra);
    margin-right: 0.25rem;
  }

  /* "Currently:" / "Goal:" activity description labels */
  .act-item {
    display: block;
    margin-top: 0.5rem;
    padding-left: 0.75rem;
    border-left: 2px solid var(--border);
  }
  .act-item.act-item-current { border-left-color: var(--sage); }
  .act-item.act-item-goal { border-left-color: var(--terra); }
  .act-label {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: 0.3rem;
  }
  .act-current { color: var(--sage-dark); }
  .act-goal { color: var(--terra); }

  /* Parenthetical notes on application round badges (e.g. "EA (merit deadline)") */
  .round-note {
    font-size: 0.7rem;
    color: var(--muted);
    font-style: italic;
  }

  /* Likely vs Aspirational flags */
  .flag-likely {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    background: #e8f5e9;
    color: #2e7d32;
  }
  .flag-aspirational {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    background: var(--terra-light);
    color: var(--terra);
  }

  /* ---- SIMULATION RESULTS ---- */
  .sim-section {
    max-width: 780px;
    margin: 0 auto;
    padding: 0 2rem 2rem;
  }

  .sim-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-top: 2.5rem;
    border-top: 3px solid var(--sage);
  }

  .sim-header h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.9rem;
    font-weight: 500;
    letter-spacing: -0.02em;
    margin-bottom: 0.25rem;
    border-top: none;
    padding-top: 0;
  }

  .sim-header p {
    font-size: 0.82rem;
    color: var(--muted);
  }

  .sim-portfolio {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .sim-stat-card {
    background: var(--sage-light);
    border-radius: 10px;
    padding: 1.25rem;
    text-align: center;
  }

  .sim-stat-value {
    font-family: 'Newsreader', serif;
    font-size: 2rem;
    font-weight: 500;
    color: var(--sage-dark);
    line-height: 1.1;
  }

  .sim-stat-label {
    font-size: 0.78rem;
    color: var(--muted);
    margin-top: 0.35rem;
    line-height: 1.4;
  }

  .sim-controls {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1rem;
  }

  .sim-expand-all {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--sage);
    background: none;
    border: 1px solid var(--sage);
    border-radius: 5px;
    padding: 0.35rem 0.85rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .sim-expand-all:hover { background: var(--sage-light); }

  .sim-tier-group {
    margin-bottom: 1.75rem;
  }

  .sim-tier-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    margin-bottom: 0.75rem;
    user-select: none;
  }

  .sim-tier-header:hover .sim-tier-label { opacity: 0.85; }

  .sim-tier-arrow {
    font-size: 0.7rem;
    color: var(--muted);
    transition: transform 0.2s;
  }

  .sim-tier-group.collapsed .sim-tier-arrow { transform: rotate(0deg); }
  .sim-tier-group:not(.collapsed) .sim-tier-arrow { transform: rotate(90deg); }
  .sim-tier-group.collapsed .sim-schools-list { display: none; }

  .sim-tier-label {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.4rem 0.85rem;
    border-radius: 5px;
    display: inline-block;
  }

  .sim-tier-count {
    font-size: 0.78rem;
    color: var(--muted);
  }

  .sim-tier-label.reach { background: var(--terra-light); color: var(--terra); }
  .sim-tier-label.target { background: var(--sage-light); color: var(--sage-dark); }
  .sim-tier-label.safety { background: var(--cream); color: var(--muted); border: 1px solid var(--border); }

  .sim-schools-list {
  }

  .sim-school-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 0.75rem;
  }

  .sim-school-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
  }

  .sim-school-header:hover .sim-school-name { color: var(--sage-dark); }

  .sim-school-left {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
  }

  .sim-school-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--ink);
    transition: color 0.15s;
  }

  .sim-school-name::before {
    content: none;
  }

  .sim-school-tier {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .sim-school-summary {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    flex-shrink: 0;
  }

  .sim-summary-stat {
    text-align: right;
  }

  .sim-summary-stat .val {
    font-size: 0.92rem;
    font-weight: 600;
    color: var(--ink);
    line-height: 1.2;
  }

  .sim-summary-stat .lbl {
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .sim-expand-arrow {
    font-size: 0.7rem;
    color: var(--muted);
    transition: transform 0.2s;
    margin-left: 0.5rem;
  }

  .sim-school-card.open .sim-expand-arrow {
    transform: rotate(90deg);
  }

  .sim-school-details {
    display: none;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
  }

  .sim-school-card.open .sim-school-details {
    display: block;
  }

  .sim-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .sim-metric {
    margin-bottom: 0.5rem;
  }

  .sim-metric-label {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--sage-dark);
    margin-bottom: 0.4rem;
  }

  .sim-bar {
    height: 24px;
    background: var(--cream);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .sim-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
  }

  .sim-bar-fill.sage { background: var(--sage); }
  .sim-bar-fill.terra { background: var(--terra); }
  .sim-bar-fill.green { background: #4caf50; }

  .sim-bar-label {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--ink);
  }

  .sim-bar-label.inside { color: white; }

  .sim-box-plot {
    position: relative;
    height: 32px;
    background: var(--cream);
    border-radius: 4px;
    margin: 0.4rem 0;
  }

  .sim-box-plot-range {
    position: absolute;
    top: 4px;
    height: 24px;
    background: var(--sage-light);
    border-radius: 3px;
  }

  .sim-box-plot-iqr {
    position: absolute;
    top: 2px;
    height: 28px;
    background: var(--sage);
    opacity: 0.3;
    border-radius: 3px;
  }

  .sim-box-plot-median {
    position: absolute;
    top: 0;
    width: 3px;
    height: 32px;
    background: var(--sage-dark);
    border-radius: 2px;
  }

  .sim-cost-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.72rem;
    color: var(--muted);
    margin-top: 0.15rem;
  }

  .sim-cost-median {
    font-size: 0.92rem;
    font-weight: 600;
    color: var(--ink);
    margin-bottom: 0.25rem;
  }

  .sim-affordable-badge {
    display: inline-block;
    font-size: 0.72rem;
    font-weight: 700;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    margin-top: 0.25rem;
  }

  .sim-affordable-badge.good { background: #e8f5e9; color: #2e7d32; }
  .sim-affordable-badge.ok { background: #fff8e1; color: #f57f17; }
  .sim-affordable-badge.bad { background: #fce4ec; color: #c62828; }

  .sim-merit-line {
    font-size: 0.82rem;
    color: #3d3d3a;
    margin-top: 0.25rem;
  }

  .sim-budget-callout {
    background: #fff8e1;
    border: 1px solid #ffe082;
    border-radius: 10px;
    padding: 1.25rem 1.5rem;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-size: 0.88rem;
    line-height: 1.6;
    color: #5d4037;
  }

  .sim-budget-callout strong { color: #e65100; }

  .sim-budget-callout .callout-title {
    font-weight: 700;
    font-size: 0.92rem;
    margin-bottom: 0.4rem;
    color: #bf360c;
  }

  @media (max-width: 640px) {
    .sim-portfolio { grid-template-columns: 1fr; }
    .sim-metrics { grid-template-columns: 1fr; }
    .sim-section { padding: 0 1.25rem 2rem; }
    .sim-stat-value { font-size: 1.6rem; }
    .sim-school-summary { gap: 0.75rem; }
    .sim-summary-stat .val { font-size: 0.82rem; }
    .sim-school-name { font-size: 0.88rem; }
  }

  /* ---- BACK TO TOP ---- */
  .back-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 40px;
    height: 40px;
    background: var(--sage);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s, background 0.2s;
    pointer-events: none;
    z-index: 50;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .back-to-top.visible {
    opacity: 1;
    pointer-events: auto;
  }
  .back-to-top:hover { background: var(--sage-dark); }

  /* ---- LOADING ---- */
  .loading {
    text-align: center;
    padding: 8rem 2rem;
  }

  .loading h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.4rem;
    font-weight: 400;
    margin-bottom: 0.75rem;
  }

  .loading p {
    font-size: 0.88rem;
    color: var(--muted);
  }

  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--sage-light);
    border-top-color: var(--sage);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1.5rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg {
    text-align: center;
    padding: 8rem 2rem;
  }
  .error-msg h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.4rem;
    font-weight: 400;
    margin-bottom: 0.5rem;
  }
  .error-msg p {
    font-size: 0.88rem;
    color: var(--muted);
  }

  /* ---- SUBMISSION INFO TOGGLE ---- */
  .submission-toggle {
    max-width: 780px;
    margin: 1.5rem auto 0;
    padding: 0 2rem;
  }

  .submission-toggle-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    width: 100%;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--sage-dark);
    background: var(--sage-light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.85rem 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .submission-toggle-btn:hover {
    background: var(--cream);
    border-color: var(--sage);
  }

  .submission-toggle-btn .arrow {
    transition: transform 0.2s;
    font-size: 0.75rem;
  }

  .submission-toggle-btn.open .arrow {
    transform: rotate(90deg);
  }

  .submission-info {
    max-width: 780px;
    margin: 0 auto;
    padding: 0.75rem 2rem 0;
    display: none;
  }

  .submission-info.visible { display: block; }

  .submission-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.75rem 2rem;
    margin-bottom: 1rem;
  }

  .submission-card h3 {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--sage);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }

  .submission-section-label {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: white;
    background: var(--sage);
    padding: 0.3rem 0.75rem;
    border-radius: 4px;
    display: inline-block;
    margin-bottom: 0.75rem;
  }

  .submission-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem 2.5rem;
  }

  .submission-field {
    margin-bottom: 0.25rem;
  }

  .submission-field .label {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--sage-dark);
    margin-bottom: 0.2rem;
  }

  .submission-field .value {
    font-size: 0.9rem;
    color: var(--ink);
    line-height: 1.6;
  }

  .submission-field.full-width {
    grid-column: 1 / -1;
  }

  @media (max-width: 640px) {
    .submission-grid { grid-template-columns: 1fr; }
    .submission-toggle { padding: 0 1.25rem; }
    .submission-info { padding: 0.75rem 1.25rem 0; }
  }

  /* ---- FOOTER ---- */
  .plan-footer {
    max-width: 780px;
    margin: 0 auto;
    padding: 2rem 2rem 4rem;
    text-align: center;
    border-top: 1px solid var(--border);
  }

  .plan-footer p {
    font-size: 0.82rem;
    color: var(--muted);
    line-height: 1.6;
  }

  .plan-footer a {
    color: var(--sage);
    text-decoration: none;
    font-weight: 600;
  }

  /* ---- SIDEBAR NAV ---- */
  .sidebar-nav {
    position: fixed;
    top: 52px;
    left: 0;
    width: 240px;
    height: calc(100vh - 52px);
    overflow-y: auto;
    padding: 1.5rem 1rem 2rem 1.25rem;
    background: var(--warm-white);
    border-right: 1px solid var(--border);
    z-index: 40;
    display: none;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .sidebar-nav::-webkit-scrollbar { width: 4px; }
  .sidebar-nav::-webkit-scrollbar-track { background: transparent; }
  .sidebar-nav::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .sidebar-title {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--sage);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-list {
    list-style: none;
  }

  .sidebar-list li {
    margin-bottom: 0.1rem;
  }

  .sidebar-list a {
    display: block;
    font-size: 0.75rem;
    color: var(--muted);
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border-left: 2px solid transparent;
    transition: all 0.15s;
    line-height: 1.4;
  }

  .sidebar-list a:hover {
    color: var(--ink);
    background: var(--cream);
  }

  .sidebar-list .sb-h1 a {
    font-weight: 600;
    color: var(--ink);
    font-size: 0.78rem;
    margin-top: 0.5rem;
    padding-left: 0.5rem;
  }

  .sidebar-list .sb-h1:first-child a { margin-top: 0; }

  .sidebar-list .sb-h2 a {
    padding-left: 1rem;
    font-size: 0.72rem;
  }

  .sidebar-list a.active {
    color: var(--sage-dark);
    background: var(--sage-light);
    border-left-color: var(--sage);
    font-weight: 600;
  }

  /* Outline toggle button (visible on screens < 1100px) */
  .outline-toggle {
    display: none;
    position: fixed;
    bottom: 1.5rem;
    left: 1.5rem;
    z-index: 50;
    background: var(--sage);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1rem;
    font-family: var(--body);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    transition: background 0.2s;
  }
  .outline-toggle:hover { background: var(--sage-dark); }

  /* Overlay backdrop when sidebar is open on small screens */
  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 39;
  }
  .sidebar-overlay.active { display: block; }

  /* On small screens: show toggle, sidebar is overlay when open */
  @media (max-width: 1099px) {
    .outline-toggle { display: block; }
    .sidebar-nav.open {
      display: block;
      z-index: 45;
      box-shadow: 4px 0 20px rgba(0,0,0,0.1);
    }
  }

  /* Show sidebar on wide screens, shift content right */
  @media (min-width: 1100px) {
    .sidebar-nav { display: block; }
    .outline-toggle { display: none; }
    .hero, .toc, .strategy-body, .sim-section, .plan-footer,
    .submission-toggle, .submission-info { margin-left: 270px; }
    .hero-inner, .strategy-body, .sim-section, .plan-footer { max-width: 780px; }
  }

  /* ---- RESPONSIVE ---- */
  @media (max-width: 640px) {
    .topbar { padding: 0 1rem; }
    .hero { padding: 5.5rem 1.25rem 2.5rem; }
    .strategy-body { padding: 1.5rem 1.25rem 3rem; }
    .toc { padding: 1.25rem; margin-left: 1.25rem; margin-right: 1.25rem; }
    .toc-columns { grid-template-columns: 1fr; }
    .strategy-body table { font-size: 0.75rem; }
    .strategy-body th, .strategy-body td { padding: 0.5rem; }
    .back-to-top { bottom: 1rem; right: 1rem; }
    .outline-toggle { bottom: 1rem; left: 1rem; }
  }
</style>
</head>
<body>

<div class="progress-bar" id="progress-bar"></div>

<nav class="topbar">
  <a href="index.html" class="topbar-logo"><span>S</span>caffold</a>
  <div class="topbar-right">
    <a href="index.html" class="topbar-link">Home</a>
    <a href="intake.html" class="topbar-cta">Get Your Plan</a>
  </div>
</nav>

<div class="sample-bar" id="sample-bar">
  <span class="sample-bar-label">Sample plans:</span>
  <a href="plan.html?id=mltutk4ma02soi" data-sample-id="mltutk4ma02soi">Alejandra's Plan</a>
  <span class="sample-bar-sep">|</span>
  <a href="plan.html?id=mltutk640laqpi" data-sample-id="mltutk640laqpi">Priya's Plan</a>
  <span class="sample-bar-sep">|</span>
  <a href="plan.html?id=mltutjs3t6hf1q" data-sample-id="mltutjs3t6hf1q">Jake's Plan</a>
</div>

<!-- BACK TO TOP -->
<button class="back-to-top" id="back-to-top" title="Back to top">&uarr;</button>

<!-- OUTLINE TOGGLE (visible on small screens) -->
<button class="outline-toggle" id="outline-toggle">Outline</button>
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<!-- SIDEBAR NAV (populated by JS, visible on wide screens) -->
<nav class="sidebar-nav" id="sidebar-nav">
  <div class="sidebar-title">Outline</div>
  <ul class="sidebar-list" id="sidebar-list"></ul>
</nav>

<!-- LOADING STATE -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <h2>Loading your plan...</h2>
  <p>This should only take a moment.</p>
</div>

<!-- ERROR STATE -->
<div class="error-msg" id="error" style="display: none;">
  <h2>Plan not found</h2>
  <p>This plan may still be generating, or the link may be incorrect. Check back shortly.</p>
</div>

<!-- PLAN CONTENT (hidden until loaded) -->
<div id="plan-content" style="display: none;">
  <section class="hero">
    <div class="hero-inner">
      <div class="hero-badge">Your Scaffold Plan</div>
      <h1 id="plan-title"></h1>
      <p class="hero-meta" id="plan-meta"></p>
    </div>
  </section>

  <!-- SUBMISSION INFO (collapsible) - right after hero for visibility -->
  <div class="submission-toggle" id="submission-toggle" style="display: none;">
    <button class="submission-toggle-btn" onclick="toggleSubmission()">
      <span class="arrow">&#9654;</span> View What You Submitted
    </button>
  </div>
  <div class="submission-info" id="submission-info">
    <div class="submission-card" id="submission-card"></div>
  </div>

  <nav class="toc" id="toc" style="display: none;">
    <div class="toc-title">In this plan</div>
    <div class="toc-columns">
      <ul class="toc-list" id="toc-col1"></ul>
      <ul class="toc-list" id="toc-col2"></ul>
    </div>
  </nav>

  <div class="strategy-body" id="strategy-body"></div>

  <!-- SIMULATION RESULTS (rendered if data available) -->
  <div class="sim-section" id="sim-section" style="display: none;"></div>

  <div class="plan-footer">
    <p>This plan was generated by <a href="index.html">Scaffold</a>. Bookmark this page to come back to it.</p>
  </div>
</div>

<script>
  // Scroll progress + back to top
  const backBtn = document.getElementById('back-to-top');
  window.addEventListener('scroll', () => {
    const bar = document.getElementById('progress-bar');
    const h = document.documentElement.scrollHeight - window.innerHeight;
    if (h > 0) bar.style.width = (window.scrollY / h * 100) + '%';
    if (window.scrollY > 600) {
      backBtn.classList.add('visible');
    } else {
      backBtn.classList.remove('visible');
    }
  });
  backBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

  // Outline toggle for small screens
  const outlineToggle = document.getElementById('outline-toggle');
  const sidebarOverlay = document.getElementById('sidebar-overlay');
  const sidebarNav = document.getElementById('sidebar-nav');

  function closeSidebar() {
    sidebarNav.classList.remove('open');
    sidebarOverlay.classList.remove('active');
  }

  outlineToggle.addEventListener('click', () => {
    const isOpen = sidebarNav.classList.contains('open');
    if (isOpen) {
      closeSidebar();
    } else {
      sidebarNav.classList.add('open');
      sidebarOverlay.classList.add('active');
    }
  });

  sidebarOverlay.addEventListener('click', closeSidebar);

  // Close sidebar when clicking a link in it (on mobile)
  sidebarNav.addEventListener('click', (e) => {
    if (e.target.tagName === 'A') closeSidebar();
  });

  // Markdown to HTML converter
  function markdownToHtml(md) {
    // Pre-process: extract tables before line-by-line processing
    const tableBlocks = [];
    md = md.replace(/(?:^|\n)((?:\|.+\|\n?)+)/g, (match, tableBlock) => {
      const rows = tableBlock.trim().split('\n').filter(r => r.trim());
      if (rows.length < 2) return match;

      // Check if second row is separator
      const sep = rows[1];
      if (!/^\|[\s\-:|]+\|$/.test(sep.trim())) return match;

      const headers = rows[0].split('|').filter((c, i, a) => i > 0 && i < a.length - 1).map(c => c.trim());
      const bodyRows = rows.slice(2);

      let html = '<table><thead><tr>';
      headers.forEach(h => { html += `<th>${h}</th>`; });
      html += '</tr></thead><tbody>';

      bodyRows.forEach(row => {
        const cells = row.split('|').filter((c, i, a) => i > 0 && i < a.length - 1).map(c => c.trim());
        html += '<tr>';
        cells.forEach(c => {
          // Apply inline formatting to cell contents
          c = c.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
          c = c.replace(/\*(.+?)\*/g, '<em>$1</em>');
          html += `<td>${c}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      const placeholder = `\n<!--TABLE_${tableBlocks.length}-->\n`;
      tableBlocks.push(html);
      return placeholder;
    });

    let html = md
      // Escape HTML (but not our table placeholders)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      // Restore table placeholders
      .replace(/&lt;!--TABLE_(\d+)--&gt;/g, (m, i) => tableBlocks[i])
      // Headers
      .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2 id="__ID__">$1</h2>')
      .replace(/^# (.+)$/gm, '<h1 id="__ID__">$1</h1>')
      // Bold and italic
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      // Horizontal rules
      .replace(/^---+$/gm, '<hr>')
      // Blockquotes
      .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
      // Unordered lists
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      // Ordered lists
      .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
      // Wrap consecutive <li> in <ul>
      .replace(/((?:<li>.+<\/li>\n?)+)/g, '<ul>$1</ul>')
      // Paragraphs: wrap lines that aren't already tags
      .replace(/^(?!<[huptlbo]|<\/|<!--)(.+)$/gm, '<p>$1</p>')
      // Clean up empty paragraphs
      .replace(/<p>\s*<\/p>/g, '')
      // Merge consecutive blockquotes
      .replace(/<\/blockquote>\n<blockquote>/g, '<br>');

    // Generate IDs for headers
    let idCounter = 0;
    html = html.replace(/__ID__/g, () => 'section-' + (idCounter++));

    return html;
  }

  // Post-process: add badges and visual enhancements
  function enhanceContent(container) {
    // Wrap tables in scrollable container
    container.querySelectorAll('table').forEach(table => {
      if (!table.parentElement.classList.contains('table-wrap')) {
        const wrapper = document.createElement('div');
        wrapper.className = 'table-wrap';
        table.parentElement.insertBefore(wrapper, table);
        wrapper.appendChild(table);
      }
    });

    // --- Table enhancements ---
    const tables = container.querySelectorAll('table');
    let isFirst = true;

    tables.forEach(table => {
      if (isFirst) {
        table.classList.add('exec-summary');
        isFirst = false;
      }

      table.querySelectorAll('td').forEach(td => {
        const text = td.textContent.trim().toLowerCase();

        // Tier badges
        if (text === 'reach') {
          td.innerHTML = '<span class="tier-badge tier-reach">Reach</span>';
        } else if (text === 'target') {
          td.innerHTML = '<span class="tier-badge tier-target">Target</span>';
        } else if (text === 'safety' || text === 'likely safety') {
          td.innerHTML = '<span class="tier-badge tier-safety">Safety</span>';
        }

        // Financial risk badges — match any risk-like value dynamically
        const riskMap = { 'very low': 'risk-very-low', 'low': 'risk-low', 'moderate': 'risk-moderate', 'high': 'risk-high', 'very high': 'risk-very-high' };
        const riskClass = riskMap[text];
        if (riskClass) {
          const label = text.split(' ').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
          td.innerHTML = '<span class="risk-badge ' + riskClass + '">' + label + '</span>';
        } else if (text.includes('risk') || text.includes('low') || text.includes('high') || text.includes('moderate')) {
          // Catch-all for any other risk-like value Claude might create
          const fallbackClass = text.includes('high') ? 'risk-high' : text.includes('low') ? 'risk-low' : 'risk-moderate';
          const label = text.split(' ').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
          td.innerHTML = '<span class="risk-badge ' + fallbackClass + '">' + label + '</span>';
        }

        // Application round badges in table cells
        // Strip parenthetical notes and footnote markers for matching
        const roundBase = text.replace(/\s*\(.*\)$/, '').replace(/[¹²³⁴⁵⁶⁷⁸⁹⁰\*†‡§]+$/, '').trim();
        const roundColors = {
          'ea': 'tier-target', 'early action': 'tier-target',
          'ed': 'tier-reach', 'early decision': 'tier-reach', 'ed1': 'tier-reach',
          'ed2': 'tier-reach', 'early decision ii': 'tier-reach',
          'rd': 'tier-safety', 'regular decision': 'tier-safety',
          'rea': 'tier-reach', 'restrictive early action': 'tier-reach',
          'scea': 'tier-reach', 'single-choice early action': 'tier-reach',
          'rolling': 'tier-safety', 'rolling admission': 'tier-safety',
        };
        if (roundColors[roundBase]) {
          const noteMatch = text.match(/(\(.*\))$/);
          const roundNote = noteMatch ? ' <span class="round-note">' + noteMatch[1] + '</span>' : '';
          const footnoteMatch = td.textContent.trim().match(/([¹²³⁴⁵⁶⁷⁸⁹⁰\*†‡§]+)$/);
          const footnote = footnoteMatch ? '<sup>' + footnoteMatch[1] + '</sup>' : '';
          const roundLabels = {
            'early action': 'EA', 'early decision': 'ED', 'early decision ii': 'ED2',
            'regular decision': 'RD', 'restrictive early action': 'REA',
            'single-choice early action': 'SCEA', 'rolling admission': 'Rolling',
          };
          const label = roundLabels[roundBase] || roundBase.toUpperCase();
          td.innerHTML = '<span class="tier-badge ' + roundColors[roundBase] + '">' + label + '</span>' + footnote + roundNote;
        }
      });

      // --- Fix decimal admit rates in table columns ---
      // Detect columns with "admit" in the header and convert decimals to percentages
      const headers = table.querySelectorAll('th');
      headers.forEach((th, colIdx) => {
        const hText = th.textContent.toLowerCase();
        if (hText.includes('admit') || hText.includes('acceptance')) {
          table.querySelectorAll('tbody tr').forEach(row => {
            const td = row.querySelectorAll('td')[colIdx];
            if (!td) return;
            const val = parseFloat(td.textContent.trim());
            if (!isNaN(val) && val > 0 && val < 1) {
              td.textContent = (val * 100).toFixed(0) + '%';
            }
          });
        }
      });
    });

    // --- Structure "Currently" and "Goal" activity descriptions ---
    // Handles: "Currently:", "Currently studying...", "Goal:", "Goal by senior year:"
    container.querySelectorAll('p, li, td').forEach(el => {
      // Skip elements with child block elements
      if (el.querySelector('p, ul, ol, table')) return;
      const text = el.textContent;
      const html = el.innerHTML;
      // Count "Currently" or "Goal" as standalone words
      const labels = (text.match(/\b(?:Currently|Goal)\b/gi) || []);
      if (labels.length >= 2) {
        // Multiple labels in one element — split into styled blocks
        // Split the innerHTML on Currently/Goal boundaries
        const parts = html.split(/(?=(?:<strong>)?(?:Currently|Goal)\b)/gi);
        const styled = parts.map(part => {
          const partText = part.replace(/<[^>]+>/g, '').trim();
          if (/^Currently\b/i.test(partText)) {
            return '<span class="act-item act-item-current"><strong class="act-label act-current">Currently:</strong> ' +
              part.replace(/^(?:<strong>)?Currently\b[^:]*:?\s*(?:<\/strong>)?\s*/i, '') + '</span>';
          } else if (/^Goal\b/i.test(partText)) {
            return '<span class="act-item act-item-goal"><strong class="act-label act-goal">Goal:</strong> ' +
              part.replace(/^(?:<strong>)?Goal\b[^:]*:?\s*(?:<\/strong>)?\s*/i, '') + '</span>';
          }
          return part;
        }).join('');
        el.innerHTML = styled;
      } else if (labels.length === 1) {
        // Single label — style it in place
        el.innerHTML = html
          .replace(/(?:<strong>)?(Currently\b[^:]*:?)(?:<\/strong>)?/i,
            '<strong class="act-label act-current">Currently:</strong>')
          .replace(/(?:<strong>)?(Goal\b[^:]*:?)(?:<\/strong>)?/i,
            '<strong class="act-label act-goal">Goal:</strong>');
      }
    });

    // --- Inline badges: [CURRENT], [TARGET], [Already earned], [Likely], [Aspirational] ---
    const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
    const replacements = [];
    const badgePattern = /\[(CURRENT|TARGET|CURRENT\/TARGET|ASPIRATIONAL|Already earned|Already Earned|Likely|Aspirational|LIKELY)\]/i;
    while (walker.nextNode()) {
      const node = walker.currentNode;
      if (badgePattern.test(node.textContent)) {
        replacements.push(node);
      }
    }

    replacements.forEach(node => {
      const span = document.createElement('span');
      span.innerHTML = node.textContent
        .replace(/\[CURRENT\/TARGET\]/gi, '<span class="activity-current">Current</span> <span class="activity-target">Target</span>')
        .replace(/\[CURRENT\]/gi, '<span class="activity-current">Current</span>')
        .replace(/\[TARGET\]/gi, '<span class="activity-target">Target</span>')
        .replace(/\[ASPIRATIONAL\]/gi, '<span class="flag-aspirational">Aspirational</span>')
        .replace(/\[Already earned\]/gi, '<span class="activity-current">Already Earned</span>')
        .replace(/\[Likely\]/gi, '<span class="flag-likely">Likely</span>')
        .replace(/\[LIKELY\]/gi, '<span class="flag-likely">Likely</span>');
      node.parentNode.replaceChild(span, node);
    });
  }

  // Wrap content between h2 headings into collapsible sections
  function makeCollapsible(container) {
    const h2s = container.querySelectorAll('h2[id]');
    h2s.forEach(h2 => {
      // Collect all siblings between this h2 and the next h1/h2
      const content = document.createElement('div');
      content.className = 'section-content';

      let next = h2.nextElementSibling;
      while (next && next.tagName !== 'H1' && next.tagName !== 'H2') {
        const toMove = next;
        next = next.nextElementSibling;
        content.appendChild(toMove);
      }

      // Only wrap if there's content to collapse
      if (content.children.length > 0) {
        h2.after(content);
        h2.addEventListener('click', () => {
          if (content.classList.contains('collapsed')) {
            // Expanding
            content.classList.remove('collapsed');
            h2.classList.remove('collapsed');
            content.style.maxHeight = content.scrollHeight + 'px';
          } else {
            // Collapsing: set explicit height first for smooth transition
            content.style.maxHeight = content.scrollHeight + 'px';
            content.classList.add('collapsible');
            requestAnimationFrame(() => {
              h2.classList.add('collapsed');
              content.classList.add('collapsed');
            });
          }
        });
      }
    });
  }

  // Build table of contents with two columns: Strategy Brief | Reference Sections
  function buildToc(container) {
    const headings = container.querySelectorAll('h1[id], h2[id]');
    if (headings.length < 3) return;

    const col1 = document.getElementById('toc-col1');
    const col2 = document.getElementById('toc-col2');
    let inRefSections = false;

    headings.forEach(h => {
      // "Reference Sections" and everything after goes in column 2
      if (h.textContent.toLowerCase().includes('reference section')) {
        inRefSections = true;
      }

      const li = document.createElement('li');
      li.className = h.tagName === 'H1' ? 'toc-h1' : 'toc-h2';
      const a = document.createElement('a');
      a.href = '#' + h.id;
      a.textContent = h.textContent;
      a.addEventListener('click', e => {
        e.preventDefault();
        const target = document.getElementById(h.id);
        if (target && target.classList.contains('collapsed')) {
          target.classList.remove('collapsed');
          const wrapper = target.nextElementSibling;
          if (wrapper && wrapper.classList.contains('section-content')) {
            wrapper.classList.remove('collapsed');
          }
        }
        target.scrollIntoView({ behavior: 'smooth' });
      });
      li.appendChild(a);

      if (inRefSections) {
        col2.appendChild(li);
      } else {
        col1.appendChild(li);
      }
    });

    document.getElementById('toc').style.display = 'block';

    // Add section rules after h1 headers in the content
    container.querySelectorAll('h1[id]').forEach(h1 => {
      const rule = document.createElement('div');
      rule.className = 'section-rule';
      h1.after(rule);
    });

    // Build sidebar nav from the same headings
    buildSidebar(headings);
  }

  function buildSidebar(headings) {
    const list = document.getElementById('sidebar-list');
    if (!list || headings.length < 3) return;

    headings.forEach(h => {
      const li = document.createElement('li');
      li.className = h.tagName === 'H1' ? 'sb-h1' : 'sb-h2';
      const a = document.createElement('a');
      a.href = '#' + h.id;
      a.textContent = h.textContent;
      a.dataset.target = h.id;
      a.addEventListener('click', e => {
        e.preventDefault();
        const target = document.getElementById(h.id);
        // If this is a collapsed h2, expand it first
        if (target && target.classList.contains('collapsed')) {
          target.classList.remove('collapsed');
          const wrapper = target.nextElementSibling;
          if (wrapper && wrapper.classList.contains('section-content')) {
            wrapper.classList.remove('collapsed');
          }
        }
        target.scrollIntoView({ behavior: 'smooth' });
      });
      li.appendChild(a);
      list.appendChild(li);
    });

    // Track active section with IntersectionObserver
    const sidebarLinks = list.querySelectorAll('a');
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          sidebarLinks.forEach(a => a.classList.remove('active'));
          const active = list.querySelector('a[data-target="' + entry.target.id + '"]');
          if (active) {
            active.classList.add('active');
            // Scroll sidebar to keep active item visible
            active.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        }
      });
    }, { rootMargin: '-80px 0px -70% 0px', threshold: 0 });

    headings.forEach(h => observer.observe(h));
  }

  function formatDollars(n) {
    if (n == null) return '-';
    return '$' + n.toLocaleString('en-US');
  }

  function formatPct(n) {
    return Math.round(n * 100) + '%';
  }

  function renderSimulation(sim) {
    if (!sim || !sim.schools || sim.schools.length === 0) return;

    const section = document.getElementById('sim-section');
    const portfolio = sim.portfolio;

    // Find the max sticker cost for box plot scaling
    const maxCost = Math.max(...sim.schools.map(s => s.sticker_cost || 0));

    let html = '';

    // Header
    html += '<div class="sim-header">';
    html += '<h2 id="sim-results">Financial Simulation Results</h2>';
    html += '<p>Based on ' + sim.iterations.toLocaleString() + ' Monte Carlo iterations using the admission and financial estimates above</p>';
    html += '</div>';

    // Portfolio summary cards
    html += '<div class="sim-portfolio">';

    html += '<div class="sim-stat-card">';
    html += '<div class="sim-stat-value">' + formatPct(portfolio.at_least_one_admit) + '</div>';
    html += '<div class="sim-stat-label">of simulations had at least one admission</div>';
    html += '</div>';

    html += '<div class="sim-stat-card">';
    html += '<div class="sim-stat-value">' + formatPct(portfolio.at_least_one_affordable) + '</div>';
    html += '<div class="sim-stat-label">had at least one admission within budget</div>';
    html += '</div>';

    html += '<div class="sim-stat-card">';
    html += '<div class="sim-stat-value">' + formatDollars(portfolio.expected_cheapest.median) + '</div>';
    html += '<div class="sim-stat-label">expected cheapest option (median)</div>';
    html += '</div>';

    html += '</div>';

    // Budget reality callout
    const affRate = portfolio.at_least_one_affordable;
    const budget = portfolio.family_budget;
    const cheapest = portfolio.expected_cheapest ? portfolio.expected_cheapest.median : null;

    if (affRate <= 0.15 && budget != null && cheapest != null) {
      html += '<div class="sim-budget-callout">';
      html += '<div class="callout-title">Budget gap flagged</div>';
      if (affRate === 0) {
        html += '<p>In none of our 10,000 simulations did any school on this list come in at or below the stated <strong>' + formatDollars(budget) + '/year</strong> budget. ';
      } else {
        html += '<p>Only <strong>' + formatPct(affRate) + '</strong> of simulations produced an admission within the stated <strong>' + formatDollars(budget) + '/year</strong> budget. ';
      }
      html += 'The expected cheapest option is <strong>' + formatDollars(cheapest) + '/year</strong> (median). ';
      html += 'This does not mean these schools are out of reach. It means the financial plan needs attention: ';
      html += 'additional scholarships, work-study, parent PLUS loans, or adjusting the school list could close this gap. ';
      html += 'The strategy sections above address this in detail.</p>';
      html += '</div>';
    }

    // Expand All / Collapse All control
    html += '<div class="sim-controls">';
    html += '<button class="sim-expand-all" onclick="toggleAllSim()">Expand All</button>';
    html += '</div>';

    // Group schools by tier
    const tierOrder = ['reach', 'target', 'safety'];
    const tierLabels = { reach: 'Reaches', target: 'Targets', safety: 'Safeties' };
    const grouped = {};
    sim.schools.forEach(school => {
      const t = tierOrder.includes(school.tier) ? school.tier : 'target';
      if (!grouped[t]) grouped[t] = [];
      grouped[t].push(school);
    });

    // Find the max sticker cost for box plot scaling (recalculated here for scope)
    const maxCostForPlot = maxCost > 0 ? maxCost * 1.1 : 80000;

    tierOrder.forEach(tier => {
      const schools = grouped[tier];
      if (!schools || schools.length === 0) return;

      html += '<div class="sim-tier-group" data-tier="' + tier + '">';
      html += '<div class="sim-tier-header" onclick="toggleSimTier(this)">';
      html += '<span class="sim-tier-arrow">&#9654;</span>';
      html += '<span class="sim-tier-label ' + tier + '">' + tierLabels[tier] + '</span>';
      html += '<span class="sim-tier-count">' + schools.length + ' school' + (schools.length > 1 ? 's' : '') + '</span>';
      html += '</div>';

      html += '<div class="sim-schools-list">';

      schools.forEach(school => {
        const tierClass = school.tier === 'reach' ? 'tier-reach' : school.tier === 'target' ? 'tier-target' : 'tier-safety';

        html += '<div class="sim-school-card">';

        // Compact header with summary stats
        html += '<div class="sim-school-header" onclick="toggleSimCard(this)">';
        html += '<div class="sim-school-left">';
        html += '<span class="sim-school-name">' + escapeHtml(school.name) + '</span>';
        html += '</div>';
        html += '<div class="sim-school-summary">';
        html += '<div class="sim-summary-stat"><div class="val">' + formatPct(school.simulated_admit_rate) + '</div><div class="lbl">Admit</div></div>';
        if (school.net_cost.median !== null) {
          html += '<div class="sim-summary-stat"><div class="val">' + formatDollars(school.net_cost.median) + '</div><div class="lbl">Med. Cost</div></div>';
          const affClass = school.affordable_rate >= 0.6 ? 'good' : school.affordable_rate >= 0.3 ? 'ok' : 'bad';
          html += '<div class="sim-summary-stat"><div class="val"><span class="sim-affordable-badge ' + affClass + '">' + formatPct(school.affordable_rate) + '</span></div><div class="lbl">Within Budget</div></div>';
        }
        html += '<span class="sim-expand-arrow">&#9654;</span>';
        html += '</div>';
        html += '</div>';

        // Expandable details
        html += '<div class="sim-school-details">';
        html += '<div class="sim-metrics">';

        // Admission rate bar
        const admitPct = school.simulated_admit_rate;
        const admitWidth = Math.max(2, admitPct * 100);
        const admitLabelInside = admitPct > 0.25;

        html += '<div class="sim-metric">';
        html += '<div class="sim-metric-label">Simulated Admission Rate</div>';
        html += '<div class="sim-bar">';
        html += '<div class="sim-bar-fill sage" style="width: ' + admitWidth + '%;"></div>';
        if (admitLabelInside) {
          html += '<span class="sim-bar-label inside" style="right: auto; left: ' + (admitWidth - 1) + '%; transform: translateY(-50%) translateX(-100%); padding-right: 0.4rem;">' + formatPct(admitPct) + '</span>';
        } else {
          html += '<span class="sim-bar-label">' + formatPct(admitPct) + '</span>';
        }
        html += '</div>';
        html += '</div>';

        // Affordable rate
        if (school.net_cost.median !== null) {
          const affRate = school.affordable_rate;
          const affWidth = Math.max(2, affRate * 100);
          const affBarClass = affRate >= 0.6 ? 'green' : 'terra';

          html += '<div class="sim-metric">';
          html += '<div class="sim-metric-label">Within Budget When Admitted</div>';
          html += '<div class="sim-bar">';
          html += '<div class="sim-bar-fill ' + affBarClass + '" style="width: ' + affWidth + '%;"></div>';
          html += '<span class="sim-bar-label">' + formatPct(affRate) + '</span>';
          html += '</div>';
          html += '<div style="font-size: 0.72rem; color: var(--muted); margin-top: 0.2rem;">within ' + formatDollars(portfolio.family_budget) + '/yr budget</div>';
          html += '</div>';
        }

        // Net cost distribution (box plot)
        if (school.net_cost.median !== null) {
          const scale = maxCostForPlot;
          const minPct = (school.net_cost.min / scale) * 100;
          const p25Pct = (school.net_cost.p25 / scale) * 100;
          const medPct = (school.net_cost.median / scale) * 100;
          const p75Pct = (school.net_cost.p75 / scale) * 100;
          const maxPct = (school.net_cost.max / scale) * 100;

          html += '<div class="sim-metric" style="grid-column: 1 / -1;">';
          html += '<div class="sim-metric-label">Net Cost Distribution (when admitted)</div>';
          html += '<div class="sim-cost-median">Median: ' + formatDollars(school.net_cost.median) + '/yr</div>';
          html += '<div class="sim-box-plot">';
          html += '<div class="sim-box-plot-range" style="left: ' + minPct + '%; width: ' + (maxPct - minPct) + '%;"></div>';
          html += '<div class="sim-box-plot-iqr" style="left: ' + p25Pct + '%; width: ' + (p75Pct - p25Pct) + '%;"></div>';
          html += '<div class="sim-box-plot-median" style="left: ' + medPct + '%;"></div>';
          html += '</div>';
          html += '<div class="sim-cost-labels">';
          html += '<span>' + formatDollars(school.net_cost.min) + '</span>';
          html += '<span>' + formatDollars(school.net_cost.p25) + ' - ' + formatDollars(school.net_cost.p75) + '</span>';
          html += '<span>' + formatDollars(school.net_cost.max) + '</span>';
          html += '</div>';
          html += '</div>';
        }

        // Merit scholarship stats
        if (school.merit.rate > 0) {
          html += '<div class="sim-metric" style="grid-column: 1 / -1;">';
          html += '<div class="sim-merit-line">Merit scholarship in <strong>' + formatPct(school.merit.rate) + '</strong> of admitted scenarios';
          if (school.merit.median > 0) {
            html += ' (median award: ' + formatDollars(school.merit.median) + '/yr)';
          }
          html += '</div>';
          html += '</div>';
        }

        html += '</div>'; // sim-metrics
        html += '</div>'; // sim-school-details
        html += '</div>'; // sim-school-card
      });

      html += '</div>'; // sim-schools-list
      html += '</div>'; // sim-tier-group
    });

    section.innerHTML = html;
    section.style.display = 'block';

    // Add to sidebar
    const list = document.getElementById('sidebar-list');
    if (list) {
      const simH2 = document.getElementById('sim-results');
      if (simH2) {
        const li = document.createElement('li');
        li.className = 'sb-h1';
        const a = document.createElement('a');
        a.href = '#sim-results';
        a.textContent = 'Financial Simulation';
        a.dataset.target = 'sim-results';
        a.addEventListener('click', e => {
          e.preventDefault();
          simH2.scrollIntoView({ behavior: 'smooth' });
        });
        li.appendChild(a);
        list.appendChild(li);
      }
    }
  }

  function toggleSimCard(headerEl) {
    headerEl.closest('.sim-school-card').classList.toggle('open');
  }

  function toggleSimTier(headerEl) {
    headerEl.closest('.sim-tier-group').classList.toggle('collapsed');
  }

  function toggleAllSim() {
    const btn = document.querySelector('.sim-expand-all');
    const cards = document.querySelectorAll('.sim-school-card');
    const groups = document.querySelectorAll('.sim-tier-group');
    const anyOpen = document.querySelector('.sim-school-card.open');

    if (anyOpen) {
      // Collapse all
      cards.forEach(c => c.classList.remove('open'));
      groups.forEach(g => g.classList.add('collapsed'));
      btn.textContent = 'Expand All';
    } else {
      // Expand all
      cards.forEach(c => c.classList.add('open'));
      groups.forEach(g => g.classList.remove('collapsed'));
      btn.textContent = 'Collapse All';
    }
  }

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // Load the plan
  async function loadPlan() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    if (!id) {
      showError();
      return;
    }

    // Show sample bar if this is a sample plan
    const sampleIds = ['mltutk4ma02soi', 'mltutk640laqpi', 'mltutjs3t6hf1q'];
    if (sampleIds.includes(id)) {
      const bar = document.getElementById('sample-bar');
      bar.classList.add('visible');
      document.body.classList.add('has-sample-bar');
      const activeLink = bar.querySelector(`[data-sample-id="${id}"]`);
      if (activeLink) activeLink.classList.add('active');
    }

    try {
      const res = await fetch('/api/plan?id=' + encodeURIComponent(id));
      if (!res.ok) {
        showError();
        return;
      }

      const data = await res.json();

      if (!data.output) {
        // Still generating
        document.getElementById('loading').querySelector('h2').textContent = 'Your plan is still generating...';
        document.getElementById('loading').querySelector('p').textContent = 'Refresh this page in a few minutes.';
        return;
      }

      // Set title and meta
      const fullName = data.student_name || '';
      const firstName = data.student_first_name || fullName.split(' ')[0] || '';
      const title = fullName ? `${firstName}'s College Strategy` : 'Your College Strategy';
      document.getElementById('plan-title').textContent = title;
      document.title = title + ' — Scaffold';

      let metaParts = [];
      const location = [data.city, data.state].filter(Boolean).join(', ');
      if (location) metaParts.push(location);
      const formInfo = data.form_data || {};
      if (formInfo.student_age_grade) metaParts.push(formInfo.student_age_grade);
      if (data.completed_at) {
        const d = new Date(data.completed_at);
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        metaParts.push(months[d.getMonth()] + ' ' + d.getFullYear());
      }
      document.getElementById('plan-meta').textContent = metaParts.join(' · ');

      // Strip simulation params JSON block before rendering
      const cleanOutput = data.output.replace(/```json-simulation-params[\s\S]*?```/g, '');

      // Render content
      const body = document.getElementById('strategy-body');
      body.innerHTML = markdownToHtml(cleanOutput);

      // Hide the first h1 + its subtitle (hero already shows the title)
      const firstH1 = body.querySelector('h1');
      if (firstH1) {
        firstH1.style.display = 'none';
        // Also hide the subtitle line right after (usually an italic/em paragraph)
        let next = firstH1.nextElementSibling;
        if (next && next.tagName === 'DIV' && next.classList.contains('section-rule')) {
          next.style.display = 'none';
          next = next.nextElementSibling;
        }
        if (next && next.tagName === 'P' && (next.querySelector('em') || next.textContent.includes('|'))) {
          next.style.display = 'none';
        }
      }

      // Enhance tables, badges, and inline tags
      enhanceContent(body);

      // Make h2 sections collapsible
      makeCollapsible(body);

      // Build table of contents
      buildToc(body);

      // Render simulation results if available
      if (data.simulation) {
        renderSimulation(data.simulation);
      }

      // Build submission info if form_data exists
      if (data.form_data && Object.keys(data.form_data).length > 0) {
        buildSubmissionInfo(data.form_data);
        document.getElementById('submission-toggle').style.display = 'block';
      }

      // Show plan, hide loading
      document.getElementById('loading').style.display = 'none';
      document.getElementById('plan-content').style.display = 'block';

    } catch (err) {
      console.error('Failed to load plan:', err);
      showError();
    }
  }

  function toggleSubmission() {
    const info = document.getElementById('submission-info');
    const btn = document.querySelector('.submission-toggle-btn');
    info.classList.toggle('visible');
    btn.classList.toggle('open');
  }

  function buildSubmissionInfo(fd) {
    const card = document.getElementById('submission-card');
    const fields = [
      { section: 'Student', items: [
        { label: 'First Name', key: 'student_first_name' },
        { label: 'Last Name', key: 'student_last_name' },
        { label: 'Age / Grade', key: 'student_age_grade' },
        { label: 'School', key: 'school_name' },
        { label: 'School Type', key: 'school_type' },
        { label: 'District', key: 'school_district' },
        { label: 'Academic Profile', key: 'academic_profile', full: true },
        { label: 'Academic Strengths', key: 'academic_strengths', full: true },
        { label: 'Academic Weaknesses', key: 'academic_weaknesses', full: true },
        { label: 'Extracurriculars', key: 'extracurriculars', full: true },
      ]},
      { section: 'Interests & Personality', items: [
        { label: 'Interests', key: 'interests', full: true },
        { label: 'Personality', key: 'personality', full: true },
        { label: 'Teacher Quote', key: 'teacher_quote', full: true },
      ]},
      { section: 'Parent 1', items: [
        { label: 'Name', key: 'parent1_name' },
        { label: 'Education', key: 'parent1_education' },
        { label: 'Profession', key: 'parent1_profession', full: true },
      ]},
      { section: 'Parent 2', items: [
        { label: 'Name', key: 'parent2_name' },
        { label: 'Education', key: 'parent2_education' },
        { label: 'Profession', key: 'parent2_profession', full: true },
      ]},
      { section: 'Family', items: [
        { label: 'Family Structure', key: 'family_structure' },
        { label: 'Custody', key: 'custody', full: true },
        { label: 'FAFSA Parent', key: 'fafsa_parent' },
        { label: 'Co-Parent Relationship', key: 'coparent_relationship', full: true },
        { label: 'Siblings', key: 'siblings', full: true },
      ]},
      { section: 'Location', items: [
        { label: 'City', key: 'city' },
        { label: 'State', key: 'state' },
        { label: 'Setting', key: 'area_type' },
        { label: 'Area Context', key: 'area_context', full: true },
        { label: 'Relocation', key: 'relocation', full: true },
      ]},
      { section: 'Finances', items: [
        { label: 'Household Income', key: 'income' },
        { label: 'College Budget', key: 'college_budget' },
        { label: 'Assets', key: 'assets', full: true },
        { label: 'Special Circumstances', key: 'financial_special', full: true },
      ]},
      { section: 'School Preferences', items: [
        { label: 'Size Preference', key: 'size_preference' },
        { label: 'Geography', key: 'geographic_preference', full: true },
        { label: 'Must-Haves', key: 'must_haves', full: true },
        { label: 'Deal Breakers', key: 'deal_breakers', full: true },
        { label: 'Schools on Radar', key: 'schools_on_radar', full: true },
      ]},
      { section: 'Additional Context', items: [
        { label: 'Priorities', key: 'priority_other', full: true },
        { label: 'Additional Context', key: 'additional_context', full: true },
        { label: 'Email', key: 'email' },
      ]},
    ];

    let html = '<h3>What You Submitted</h3>';

    fields.forEach(section => {
      const hasData = section.items.some(item => fd[item.key]);
      if (!hasData) return;

      html += '<div style="margin-bottom: 1.5rem;">';
      html += '<span class="submission-section-label">' + section.section + '</span>';
      html += '<div class="submission-grid">';
      section.items.forEach(item => {
        if (!fd[item.key]) return;
        html += '<div class="submission-field' + (item.full ? ' full-width' : '') + '">';
        html += '<div class="label">' + item.label + '</div>';
        html += '<div class="value">' + (fd[item.key] + '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
        html += '</div>';
      });
      html += '</div></div>';
    });

    // Priority rankings (stored as priority_cost: 1, priority_prestige: 2, etc.)
    const priorityLabels = {
      cost: 'Minimize total cost of attendance',
      prestige: 'Prestige / brand name',
      academic_fit: 'Academic fit (programs, research, major strength)',
      location: 'Geographic location',
      culture: 'Campus culture / social fit',
      merit: 'Merit scholarship likelihood',
      outcomes: 'Post-graduation outcomes (career, earnings, grad school)'
    };
    const priorities = Object.entries(priorityLabels)
      .filter(([key]) => fd['priority_' + key])
      .map(([key, label]) => ({ rank: parseInt(fd['priority_' + key]), label }))
      .sort((a, b) => a.rank - b.rank);
    if (priorities.length > 0) {
      html += '<div style="margin-bottom: 1.5rem;">';
      html += '<span class="submission-section-label">Priority Ranking</span>';
      html += '<div class="submission-grid"><div class="submission-field full-width">';
      html += '<div class="value" style="margin:0;">';
      priorities.forEach(p => {
        html += '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.25rem 0;">';
        html += '<span style="display:inline-flex;align-items:center;justify-content:center;width:1.4rem;height:1.4rem;border-radius:50%;background:var(--sage-light);color:var(--sage-dark);font-size:0.75rem;font-weight:600;flex-shrink:0;">' + p.rank + '</span>';
        html += '<span>' + p.label + '</span></div>';
      });
      html += '</div></div></div></div>';
    }

    card.innerHTML = html;
  }

  function showError() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
  }

  loadPlan();
</script>
</body>
</html>
