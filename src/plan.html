<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Plan — Scaffold</title>
<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a18;
    --cream: #f8f5f0;
    --warm-white: #fdfcfa;
    --sage: #4a6741;
    --sage-light: #e8ede6;
    --sage-dark: #3a5233;
    --terra: #c4652a;
    --terra-light: #f5ece5;
    --muted: #6b6860;
    --border: #d9d4cc;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Sans', sans-serif;
    color: var(--ink);
    background: var(--warm-white);
    line-height: 1.7;
    -webkit-font-smoothing: antialiased;
  }

  /* ---- PROGRESS BAR ---- */
  .progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 3px;
    background: var(--sage);
    z-index: 200;
    width: 0%;
    transition: width 0.15s linear;
  }

  /* ---- TOP BAR ---- */
  .topbar {
    position: fixed;
    top: 3px;
    width: 100%;
    z-index: 100;
    background: rgba(253, 252, 250, 0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    height: 49px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .topbar-logo {
    font-family: 'Newsreader', serif;
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--ink);
    text-decoration: none;
    letter-spacing: -0.02em;
  }
  .topbar-logo span { color: var(--sage); }

  .topbar-right { display: flex; align-items: center; gap: 1.25rem; }

  .topbar-cta {
    font-size: 0.78rem;
    font-weight: 600;
    color: white;
    background: var(--sage);
    padding: 0.35rem 0.9rem;
    border-radius: 5px;
    text-decoration: none;
    transition: background 0.2s;
  }
  .topbar-cta:hover { background: var(--sage-dark); }

  .topbar-link {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.2s;
  }
  .topbar-link:hover { color: var(--ink); }

  /* ---- HERO ---- */
  .hero {
    background: var(--cream);
    color: var(--ink);
    padding: 6.5rem 2rem 3rem;
    border-bottom: 1px solid var(--border);
  }

  .hero-inner {
    max-width: 780px;
    margin: 0 auto;
  }

  .hero-badge {
    display: inline-block;
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--sage-dark);
    background: var(--sage-light);
    padding: 0.3rem 0.75rem;
    border-radius: 4px;
    margin-bottom: 1.25rem;
  }

  .hero h1 {
    font-family: 'Newsreader', serif;
    font-size: clamp(2rem, 4.5vw, 2.8rem);
    font-weight: 400;
    line-height: 1.1;
    letter-spacing: -0.03em;
    margin-bottom: 0.6rem;
  }

  .hero-meta {
    font-size: 0.88rem;
    color: var(--muted);
    margin-bottom: 0.75rem;
  }

  /* ---- TABLE OF CONTENTS ---- */
  .toc {
    max-width: 780px;
    margin: 0 auto;
    padding: 1.75rem 2rem;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-top: 2rem;
  }

  .toc-title {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--sage);
    margin-bottom: 1rem;
    padding-bottom: 0.6rem;
    border-bottom: 1px solid var(--border);
  }

  .toc-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0 2rem;
  }

  .toc-list {
    list-style: none;
    margin-bottom: 0;
  }

  .toc-list li {
    margin-bottom: 0.2rem;
  }

  .toc-list a {
    font-size: 0.82rem;
    color: var(--muted);
    text-decoration: none;
    padding: 0.3rem 0;
    display: block;
    transition: color 0.2s;
  }
  .toc-list a:hover { color: var(--sage); }

  .toc-list .toc-h1 a {
    font-weight: 600;
    color: var(--ink);
    font-size: 0.85rem;
    margin-top: 0.6rem;
  }
  .toc-list .toc-h1:first-child a { margin-top: 0; }
  .toc-list .toc-h1 a:hover { color: var(--sage); }

  .toc-list .toc-h2 { padding-left: 0.75rem; }
  .toc-list .toc-h2 a { font-size: 0.78rem; }

  /* ---- STRATEGY BODY ---- */
  .strategy-body {
    max-width: 780px;
    margin: 0 auto;
    padding: 2.5rem 2rem 4rem;
  }

  .strategy-body h1 {
    font-family: 'Newsreader', serif;
    font-size: 1.9rem;
    font-weight: 500;
    letter-spacing: -0.02em;
    margin-top: 3.5rem;
    margin-bottom: 0.25rem;
    padding: 2.5rem 0 0;
    border-top: 3px solid var(--sage);
    scroll-margin-top: 80px;
    text-wrap: balance;
  }

  .strategy-body h1:first-child { margin-top: 0; padding-top: 0; border-top: none; }

  .section-rule {
    width: 36px;
    height: 3px;
    background: var(--sage);
    border-radius: 2px;
    margin-bottom: 1.25rem;
  }

  .strategy-body h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.45rem;
    font-weight: 500;
    letter-spacing: -0.02em;
    margin-top: 2.75rem;
    margin-bottom: 0.4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
    scroll-margin-top: 80px;
    text-wrap: balance;
  }

  .strategy-body h2:first-child { margin-top: 0; padding-top: 0; border-top: none; }

  .strategy-body h3 {
    font-size: 1.05rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.5rem;
    color: var(--sage-dark);
    scroll-margin-top: 80px;
  }

  .strategy-body h4 {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--sage);
    margin-top: 1.75rem;
    margin-bottom: 0.75rem;
  }

  .strategy-body p {
    margin-bottom: 1.1rem;
    color: #3d3d3a;
    font-size: 0.92rem;
  }

  .strategy-body strong { font-weight: 600; color: var(--ink); }
  .strategy-body em { font-style: italic; }

  .strategy-body ul, .strategy-body ol {
    padding-left: 0;
    margin-bottom: 1.1rem;
    list-style: none;
  }

  .strategy-body ul > li {
    margin-bottom: 0.5rem;
    font-size: 0.92rem;
    color: #3d3d3a;
    padding-left: 1.25rem;
    position: relative;
  }

  .strategy-body ul > li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.55em;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--sage);
  }

  .strategy-body ol {
    counter-reset: ol-counter;
  }

  .strategy-body ol > li {
    margin-bottom: 0.5rem;
    font-size: 0.92rem;
    color: #3d3d3a;
    padding-left: 2rem;
    position: relative;
    counter-increment: ol-counter;
  }

  .strategy-body ol > li::before {
    content: counter(ol-counter);
    position: absolute;
    left: 0;
    top: 0.1em;
    width: 1.4rem;
    height: 1.4rem;
    border-radius: 50%;
    background: var(--sage-light);
    color: var(--sage-dark);
    font-size: 0.72rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Nested lists */
  .strategy-body li ul, .strategy-body li ol {
    margin-top: 0.4rem;
    margin-bottom: 0;
  }

  .strategy-body hr {
    border: none;
    border-top: 2px solid var(--sage-light);
    margin: 2.5rem 0;
  }

  /* ---- CALLOUT BOXES (blockquotes) ---- */
  .strategy-body blockquote {
    font-family: 'DM Sans', sans-serif;
    font-style: normal;
    font-size: 0.88rem;
    border-left: 3px solid var(--sage);
    background: var(--sage-light);
    padding: 1.1rem 1.5rem;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
    color: #3d3d3a;
    line-height: 1.6;
  }

  .strategy-body blockquote strong {
    color: var(--sage-dark);
  }

  /* ---- SCHOOL CARDS (per-school detail sections) ---- */
  .school-card {
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1.25rem 0;
  }

  .school-card h3 {
    margin-top: 0;
    color: var(--ink);
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.75rem;
  }

  /* Tables */
  .strategy-body table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
    margin: 1.25rem 0 1.75rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .strategy-body thead {
    position: sticky;
    top: 52px;
    z-index: 5;
  }

  .strategy-body th {
    text-align: left;
    font-weight: 600;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: white;
    padding: 0.65rem 0.75rem;
    border-bottom: 2px solid var(--sage-dark);
    background: var(--sage);
    white-space: nowrap;
  }

  .strategy-body td {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid #eae7e2;
    color: #3d3d3a;
    vertical-align: top;
  }

  .strategy-body tbody tr:nth-child(even) td {
    background: rgba(248, 245, 240, 0.5);
  }

  .strategy-body tr:hover td { background: rgba(232,237,230,0.3); }

  /* Tier badges in table cells */
  .tier-badge {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    white-space: nowrap;
  }
  .tier-reach { background: var(--terra-light); color: var(--terra); }
  .tier-target { background: var(--sage-light); color: var(--sage-dark); }
  .tier-safety { background: var(--cream); color: var(--muted); border: 1px solid var(--border); }

  /* Financial risk badges */
  .risk-badge {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    white-space: nowrap;
  }
  .risk-very-low { background: #e8f5e9; color: #2e7d32; }
  .risk-low { background: #e8f5e9; color: #2e7d32; }
  .risk-moderate { background: #fff8e1; color: #f57f17; }
  .risk-high { background: #fce4ec; color: #c62828; }

  /* First table (exec summary) gets extra prominence */
  .strategy-body table.exec-summary {
    border: 2px solid var(--sage);
    font-size: 0.85rem;
  }
  .strategy-body table.exec-summary th {
    font-size: 0.7rem;
    padding: 0.75rem;
  }
  .strategy-body table.exec-summary td {
    padding: 0.75rem;
  }

  /* Activity status badges */
  .activity-current {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.45rem;
    border-radius: 3px;
    background: #e8f5e9;
    color: #2e7d32;
    margin-right: 0.25rem;
  }
  .activity-target {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.45rem;
    border-radius: 3px;
    background: #e3f2fd;
    color: #1565c0;
    margin-right: 0.25rem;
  }
  .activity-aspirational {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.45rem;
    border-radius: 3px;
    background: var(--terra-light);
    color: var(--terra);
    margin-right: 0.25rem;
  }

  /* Likely vs Aspirational flags */
  .flag-likely {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    background: #e8f5e9;
    color: #2e7d32;
  }
  .flag-aspirational {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    background: var(--terra-light);
    color: var(--terra);
  }

  /* ---- BACK TO TOP ---- */
  .back-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 40px;
    height: 40px;
    background: var(--sage);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s, background 0.2s;
    pointer-events: none;
    z-index: 50;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .back-to-top.visible {
    opacity: 1;
    pointer-events: auto;
  }
  .back-to-top:hover { background: var(--sage-dark); }

  /* ---- LOADING ---- */
  .loading {
    text-align: center;
    padding: 8rem 2rem;
  }

  .loading h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.4rem;
    font-weight: 400;
    margin-bottom: 0.75rem;
  }

  .loading p {
    font-size: 0.88rem;
    color: var(--muted);
  }

  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--sage-light);
    border-top-color: var(--sage);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1.5rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg {
    text-align: center;
    padding: 8rem 2rem;
  }
  .error-msg h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.4rem;
    font-weight: 400;
    margin-bottom: 0.5rem;
  }
  .error-msg p {
    font-size: 0.88rem;
    color: var(--muted);
  }

  /* ---- SUBMISSION INFO TOGGLE ---- */
  .submission-toggle {
    max-width: 780px;
    margin: 1.5rem auto 0;
    padding: 0 2rem;
  }

  .submission-toggle-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    width: 100%;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--sage-dark);
    background: var(--sage-light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.85rem 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .submission-toggle-btn:hover {
    background: var(--cream);
    border-color: var(--sage);
  }

  .submission-toggle-btn .arrow {
    transition: transform 0.2s;
    font-size: 0.75rem;
  }

  .submission-toggle-btn.open .arrow {
    transform: rotate(90deg);
  }

  .submission-info {
    max-width: 780px;
    margin: 0 auto;
    padding: 0.75rem 2rem 0;
    display: none;
  }

  .submission-info.visible { display: block; }

  .submission-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.75rem 2rem;
    margin-bottom: 1rem;
  }

  .submission-card h3 {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--sage);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }

  .submission-section-label {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: white;
    background: var(--sage);
    padding: 0.3rem 0.75rem;
    border-radius: 4px;
    display: inline-block;
    margin-bottom: 0.75rem;
  }

  .submission-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem 2.5rem;
  }

  .submission-field {
    margin-bottom: 0.25rem;
  }

  .submission-field .label {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--sage-dark);
    margin-bottom: 0.2rem;
  }

  .submission-field .value {
    font-size: 0.9rem;
    color: var(--ink);
    line-height: 1.6;
  }

  .submission-field.full-width {
    grid-column: 1 / -1;
  }

  @media (max-width: 640px) {
    .submission-grid { grid-template-columns: 1fr; }
    .submission-toggle { padding: 0 1.25rem; }
    .submission-info { padding: 0.75rem 1.25rem 0; }
  }

  /* ---- FOOTER ---- */
  .plan-footer {
    max-width: 780px;
    margin: 0 auto;
    padding: 2rem 2rem 4rem;
    text-align: center;
    border-top: 1px solid var(--border);
  }

  .plan-footer p {
    font-size: 0.82rem;
    color: var(--muted);
    line-height: 1.6;
  }

  .plan-footer a {
    color: var(--sage);
    text-decoration: none;
    font-weight: 600;
  }

  /* ---- RESPONSIVE ---- */
  @media (max-width: 640px) {
    .topbar { padding: 0 1rem; }
    .hero { padding: 5.5rem 1.25rem 2.5rem; }
    .strategy-body { padding: 1.5rem 1.25rem 3rem; }
    .toc { padding: 1.25rem; margin-left: 1.25rem; margin-right: 1.25rem; }
    .toc-columns { grid-template-columns: 1fr; }
    .strategy-body table { font-size: 0.75rem; }
    .strategy-body th, .strategy-body td { padding: 0.5rem; }
    .back-to-top { bottom: 1rem; right: 1rem; }
  }
</style>
</head>
<body>

<div class="progress-bar" id="progress-bar"></div>

<nav class="topbar">
  <a href="index.html" class="topbar-logo"><span>S</span>caffold</a>
  <div class="topbar-right">
    <a href="index.html" class="topbar-link">Home</a>
    <a href="intake.html" class="topbar-cta">Get Your Plan</a>
  </div>
</nav>

<!-- BACK TO TOP -->
<button class="back-to-top" id="back-to-top" title="Back to top">&uarr;</button>

<!-- LOADING STATE -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <h2>Loading your plan...</h2>
  <p>This should only take a moment.</p>
</div>

<!-- ERROR STATE -->
<div class="error-msg" id="error" style="display: none;">
  <h2>Plan not found</h2>
  <p>This plan may still be generating, or the link may be incorrect. Check back shortly.</p>
</div>

<!-- PLAN CONTENT (hidden until loaded) -->
<div id="plan-content" style="display: none;">
  <section class="hero">
    <div class="hero-inner">
      <div class="hero-badge">Your Scaffold Plan</div>
      <h1 id="plan-title"></h1>
      <p class="hero-meta" id="plan-meta"></p>
    </div>
  </section>

  <!-- SUBMISSION INFO (collapsible) - right after hero for visibility -->
  <div class="submission-toggle" id="submission-toggle" style="display: none;">
    <button class="submission-toggle-btn" onclick="toggleSubmission()">
      <span class="arrow">&#9654;</span> View What You Submitted
    </button>
  </div>
  <div class="submission-info" id="submission-info">
    <div class="submission-card" id="submission-card"></div>
  </div>

  <nav class="toc" id="toc" style="display: none;">
    <div class="toc-title">In this plan</div>
    <div class="toc-columns">
      <ul class="toc-list" id="toc-col1"></ul>
      <ul class="toc-list" id="toc-col2"></ul>
    </div>
  </nav>

  <div class="strategy-body" id="strategy-body"></div>

  <div class="plan-footer">
    <p>This plan was generated by <a href="index.html">Scaffold</a>. Bookmark this page to come back to it.</p>
  </div>
</div>

<script>
  // Scroll progress + back to top
  const backBtn = document.getElementById('back-to-top');
  window.addEventListener('scroll', () => {
    const bar = document.getElementById('progress-bar');
    const h = document.documentElement.scrollHeight - window.innerHeight;
    if (h > 0) bar.style.width = (window.scrollY / h * 100) + '%';
    if (window.scrollY > 600) {
      backBtn.classList.add('visible');
    } else {
      backBtn.classList.remove('visible');
    }
  });
  backBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

  // Markdown to HTML converter
  function markdownToHtml(md) {
    // Pre-process: extract tables before line-by-line processing
    const tableBlocks = [];
    md = md.replace(/(?:^|\n)((?:\|.+\|\n?)+)/g, (match, tableBlock) => {
      const rows = tableBlock.trim().split('\n').filter(r => r.trim());
      if (rows.length < 2) return match;

      // Check if second row is separator
      const sep = rows[1];
      if (!/^\|[\s\-:|]+\|$/.test(sep.trim())) return match;

      const headers = rows[0].split('|').filter((c, i, a) => i > 0 && i < a.length - 1).map(c => c.trim());
      const bodyRows = rows.slice(2);

      let html = '<table><thead><tr>';
      headers.forEach(h => { html += `<th>${h}</th>`; });
      html += '</tr></thead><tbody>';

      bodyRows.forEach(row => {
        const cells = row.split('|').filter((c, i, a) => i > 0 && i < a.length - 1).map(c => c.trim());
        html += '<tr>';
        cells.forEach(c => {
          // Apply inline formatting to cell contents
          c = c.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
          c = c.replace(/\*(.+?)\*/g, '<em>$1</em>');
          html += `<td>${c}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      const placeholder = `\n<!--TABLE_${tableBlocks.length}-->\n`;
      tableBlocks.push(html);
      return placeholder;
    });

    let html = md
      // Escape HTML (but not our table placeholders)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      // Restore table placeholders
      .replace(/&lt;!--TABLE_(\d+)--&gt;/g, (m, i) => tableBlocks[i])
      // Headers
      .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2 id="__ID__">$1</h2>')
      .replace(/^# (.+)$/gm, '<h1 id="__ID__">$1</h1>')
      // Bold and italic
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      // Horizontal rules
      .replace(/^---+$/gm, '<hr>')
      // Blockquotes
      .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
      // Unordered lists
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      // Ordered lists
      .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
      // Wrap consecutive <li> in <ul>
      .replace(/((?:<li>.+<\/li>\n?)+)/g, '<ul>$1</ul>')
      // Paragraphs: wrap lines that aren't already tags
      .replace(/^(?!<[huptlbo]|<\/|<!--)(.+)$/gm, '<p>$1</p>')
      // Clean up empty paragraphs
      .replace(/<p>\s*<\/p>/g, '')
      // Merge consecutive blockquotes
      .replace(/<\/blockquote>\n<blockquote>/g, '<br>');

    // Generate IDs for headers
    let idCounter = 0;
    html = html.replace(/__ID__/g, () => 'section-' + (idCounter++));

    return html;
  }

  // Post-process: add badges and visual enhancements
  function enhanceContent(container) {
    // --- Table enhancements ---
    const tables = container.querySelectorAll('table');
    let isFirst = true;

    tables.forEach(table => {
      if (isFirst) {
        table.classList.add('exec-summary');
        isFirst = false;
      }

      table.querySelectorAll('td').forEach(td => {
        const text = td.textContent.trim().toLowerCase();

        // Tier badges
        if (text === 'reach') {
          td.innerHTML = '<span class="tier-badge tier-reach">Reach</span>';
        } else if (text === 'target') {
          td.innerHTML = '<span class="tier-badge tier-target">Target</span>';
        } else if (text === 'safety' || text === 'likely safety') {
          td.innerHTML = '<span class="tier-badge tier-safety">Safety</span>';
        }

        // Financial risk badges
        if (text === 'very low') {
          td.innerHTML = '<span class="risk-badge risk-very-low">Very Low</span>';
        } else if (text === 'low') {
          td.innerHTML = '<span class="risk-badge risk-low">Low</span>';
        } else if (text === 'moderate') {
          td.innerHTML = '<span class="risk-badge risk-moderate">Moderate</span>';
        } else if (text === 'high') {
          td.innerHTML = '<span class="risk-badge risk-high">High</span>';
        }

        // Application round badges in table cells
        if (text === 'ea' || text === 'early action') {
          td.innerHTML = '<span class="tier-badge tier-target">EA</span>';
        } else if (text === 'ed' || text === 'early decision' || text === 'ed1') {
          td.innerHTML = '<span class="tier-badge tier-reach">ED</span>';
        } else if (text === 'ed2' || text === 'early decision ii') {
          td.innerHTML = '<span class="tier-badge tier-reach">ED2</span>';
        } else if (text === 'rd' || text === 'regular decision') {
          td.innerHTML = '<span class="tier-badge tier-safety">RD</span>';
        } else if (text === 'rea' || text === 'restrictive early action') {
          td.innerHTML = '<span class="tier-badge tier-reach">REA</span>';
        }
      });
    });

    // --- Inline badges: [CURRENT], [TARGET], [Already earned], [Likely], [Aspirational] ---
    const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
    const replacements = [];
    const badgePattern = /\[(CURRENT|TARGET|ASPIRATIONAL|Already earned|Already Earned|Likely|Aspirational|LIKELY)\]/i;
    while (walker.nextNode()) {
      const node = walker.currentNode;
      if (badgePattern.test(node.textContent)) {
        replacements.push(node);
      }
    }

    replacements.forEach(node => {
      const span = document.createElement('span');
      span.innerHTML = node.textContent
        .replace(/\[CURRENT\]/gi, '<span class="activity-current">Current</span>')
        .replace(/\[TARGET\]/gi, '<span class="activity-target">Target</span>')
        .replace(/\[ASPIRATIONAL\]/gi, '<span class="flag-aspirational">Aspirational</span>')
        .replace(/\[Already earned\]/gi, '<span class="activity-current">Already Earned</span>')
        .replace(/\[Likely\]/gi, '<span class="flag-likely">Likely</span>')
        .replace(/\[LIKELY\]/gi, '<span class="flag-likely">Likely</span>');
      node.parentNode.replaceChild(span, node);
    });
  }

  // Build table of contents with two columns: Strategy Brief | Reference Sections
  function buildToc(container) {
    const headings = container.querySelectorAll('h1[id], h2[id]');
    if (headings.length < 3) return;

    const col1 = document.getElementById('toc-col1');
    const col2 = document.getElementById('toc-col2');
    let inRefSections = false;

    headings.forEach(h => {
      // "Reference Sections" and everything after goes in column 2
      if (h.textContent.toLowerCase().includes('reference section')) {
        inRefSections = true;
      }

      const li = document.createElement('li');
      li.className = h.tagName === 'H1' ? 'toc-h1' : 'toc-h2';
      const a = document.createElement('a');
      a.href = '#' + h.id;
      a.textContent = h.textContent;
      li.appendChild(a);

      if (inRefSections) {
        col2.appendChild(li);
      } else {
        col1.appendChild(li);
      }
    });

    document.getElementById('toc').style.display = 'block';

    // Add section rules after h1 headers in the content
    container.querySelectorAll('h1[id]').forEach(h1 => {
      const rule = document.createElement('div');
      rule.className = 'section-rule';
      h1.after(rule);
    });
  }

  // Load the plan
  async function loadPlan() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    if (!id) {
      showError();
      return;
    }

    try {
      const res = await fetch('/api/plan?id=' + encodeURIComponent(id));
      if (!res.ok) {
        showError();
        return;
      }

      const data = await res.json();

      if (!data.output) {
        // Still generating
        document.getElementById('loading').querySelector('h2').textContent = 'Your plan is still generating...';
        document.getElementById('loading').querySelector('p').textContent = 'Refresh this page in a few minutes.';
        return;
      }

      // Set title and meta
      const fullName = data.student_name || '';
      const title = fullName ? `${fullName}'s Plan` : 'Your Scaffold Plan';
      document.getElementById('plan-title').textContent = title;
      document.title = title + ' — Scaffold';

      let metaParts = [];
      if (data.city) metaParts.push(data.city);
      if (data.completed_at) metaParts.push('Generated ' + new Date(data.completed_at).toLocaleDateString());
      document.getElementById('plan-meta').textContent = metaParts.join(' · ');

      // Render content
      const body = document.getElementById('strategy-body');
      body.innerHTML = markdownToHtml(data.output);

      // Enhance tables, badges, and inline tags
      enhanceContent(body);

      // Build table of contents
      buildToc(body);

      // Build submission info if form_data exists
      if (data.form_data && Object.keys(data.form_data).length > 0) {
        buildSubmissionInfo(data.form_data);
        document.getElementById('submission-toggle').style.display = 'block';
      }

      // Show plan, hide loading
      document.getElementById('loading').style.display = 'none';
      document.getElementById('plan-content').style.display = 'block';

    } catch (err) {
      console.error('Failed to load plan:', err);
      showError();
    }
  }

  function toggleSubmission() {
    const info = document.getElementById('submission-info');
    const btn = document.querySelector('.submission-toggle-btn');
    info.classList.toggle('visible');
    btn.classList.toggle('open');
  }

  function buildSubmissionInfo(fd) {
    const card = document.getElementById('submission-card');
    const fields = [
      { section: 'Student', items: [
        { label: 'Name', key: 'student_name' },
        { label: 'Age / Grade', key: 'student_age_grade' },
        { label: 'School', key: 'school_name' },
        { label: 'School Type', key: 'school_type' },
        { label: 'District', key: 'school_district' },
        { label: 'Academic Profile', key: 'academic_profile', full: true },
        { label: 'Strengths', key: 'strengths', full: true },
        { label: 'Weaknesses', key: 'weaknesses', full: true },
      ]},
      { section: 'Interests & Personality', items: [
        { label: 'Interests', key: 'interests', full: true },
        { label: 'Personality', key: 'personality', full: true },
        { label: 'Teacher Quote', key: 'teacher_quote', full: true },
      ]},
      { section: 'Parent 1', items: [
        { label: 'Name', key: 'parent1_name' },
        { label: 'Education', key: 'parent1_education' },
        { label: 'Profession', key: 'parent1_profession', full: true },
      ]},
      { section: 'Parent 2', items: [
        { label: 'Name', key: 'parent2_name' },
        { label: 'Education', key: 'parent2_education' },
        { label: 'Profession', key: 'parent2_profession', full: true },
      ]},
      { section: 'Family', items: [
        { label: 'Family Structure', key: 'family_structure' },
        { label: 'Siblings', key: 'siblings', full: true },
      ]},
      { section: 'Location', items: [
        { label: 'City', key: 'city' },
        { label: 'Setting', key: 'urban_suburban_rural' },
        { label: 'Relocation', key: 'relocation', full: true },
      ]},
      { section: 'Finances', items: [
        { label: 'Household Income', key: 'income' },
        { label: 'College Budget', key: 'college_budget' },
        { label: 'Assets', key: 'assets', full: true },
        { label: 'Special Circumstances', key: 'special_circumstances', full: true },
      ]},
      { section: 'School Preferences', items: [
        { label: 'Size Preference', key: 'school_size' },
        { label: 'Geography', key: 'school_geography', full: true },
        { label: 'Must-Haves', key: 'must_haves', full: true },
        { label: 'Deal Breakers', key: 'deal_breakers', full: true },
        { label: 'Schools on Radar', key: 'schools_on_radar', full: true },
      ]},
      { section: 'Additional Context', items: [
        { label: 'Additional Priorities', key: 'additional_priorities', full: true },
        { label: 'Additional Context', key: 'additional_context', full: true },
      ]},
    ];

    let html = '<h3>What You Submitted</h3>';

    fields.forEach(section => {
      const hasData = section.items.some(item => fd[item.key]);
      if (!hasData) return;

      html += '<div style="margin-bottom: 1.5rem;">';
      html += '<span class="submission-section-label">' + section.section + '</span>';
      html += '<div class="submission-grid">';
      section.items.forEach(item => {
        if (!fd[item.key]) return;
        html += '<div class="submission-field' + (item.full ? ' full-width' : '') + '">';
        html += '<div class="label">' + item.label + '</div>';
        html += '<div class="value">' + (fd[item.key] + '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
        html += '</div>';
      });
      html += '</div></div>';
    });

    card.innerHTML = html;
  }

  function showError() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
  }

  loadPlan();
</script>
</body>
</html>
