<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scaffold Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a18;
    --cream: #f8f5f0;
    --warm-white: #fdfcfa;
    --sage: #4a6741;
    --sage-light: #e8ede6;
    --muted: #6b6860;
    --border: #d9d4cc;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; color: var(--ink); background: var(--warm-white); padding: 2rem; }
  h1 { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.5rem; }
  .subtitle { font-size: 0.85rem; color: var(--muted); margin-bottom: 2rem; }
  .gate { text-align: center; padding: 4rem 1rem; }
  .gate input { padding: 0.6rem 1rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; font-family: 'DM Sans', sans-serif; width: 200px; }
  .gate button { padding: 0.6rem 1.25rem; background: var(--sage); color: white; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-left: 0.5rem; font-family: 'DM Sans', sans-serif; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th { text-align: left; padding: 0.6rem 0.75rem; background: var(--cream); border: 1px solid var(--border); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.03em; }
  td { padding: 0.6rem 0.75rem; border: 1px solid var(--border); }
  td.stage-cell { white-space: nowrap; min-width: 100px; }
  .status-generating { color: #b8860b; font-weight: 600; }
  .status-completed { color: var(--sage); font-weight: 600; }
  .status-failed { color: var(--error, #c94d4d); font-weight: 600; }
  .btn-view { font-size: 0.78rem; color: var(--sage); font-weight: 600; cursor: pointer; text-decoration: underline; background: none; border: none; font-family: 'DM Sans', sans-serif; }
  .badge-free { font-size: 0.72rem; font-weight: 600; background: var(--cream); color: var(--muted); padding: 0.15rem 0.5rem; border-radius: 3px; border: 1px solid var(--border); }
  .badge-paid { font-size: 0.72rem; font-weight: 600; background: #e8f5e9; color: #2e7d32; padding: 0.15rem 0.5rem; border-radius: 3px; }
  .plan-link { font-size: 0.78rem; color: var(--sage); font-weight: 500; text-decoration: none; }
  .plan-link:hover { text-decoration: underline; }
  .empty { text-align: center; padding: 3rem; color: var(--muted); }
  .detail-panel { margin-top: 2rem; padding: 1.5rem; background: var(--cream); border: 1px solid var(--border); border-radius: 8px; display: none; }
  .detail-panel h2 { font-size: 1.1rem; margin-bottom: 1rem; }
  .detail-tabs { display: flex; gap: 0; margin-bottom: 1rem; border-bottom: 2px solid var(--border); }
  .detail-tab { padding: 0.5rem 1.25rem; font-size: 0.82rem; font-weight: 600; color: var(--muted); background: none; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
  .detail-tab:hover { color: var(--ink); }
  .detail-tab.active { color: var(--sage); border-bottom-color: var(--sage); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .detail-section { margin-bottom: 1.5rem; }
  .detail-section h3 { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--sage); margin-bottom: 0.5rem; }
  .detail-section pre { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 1rem; font-size: 0.82rem; white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; font-family: 'DM Sans', sans-serif; line-height: 1.6; }
  .rendered-plan { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 1.5rem 2rem; max-height: 600px; overflow-y: auto; font-size: 0.88rem; line-height: 1.7; }
  .rendered-plan h1 { font-size: 1.4rem; font-weight: 600; margin: 2rem 0 0.5rem; padding-top: 1.5rem; border-top: 2px solid var(--sage); }
  .rendered-plan h1:first-child { margin-top: 0; padding-top: 0; border-top: none; }
  .rendered-plan h2 { font-size: 1.15rem; font-weight: 600; margin: 1.5rem 0 0.4rem; padding-top: 1rem; border-top: 1px solid var(--border); }
  .rendered-plan h2:first-child { margin-top: 0; padding-top: 0; border-top: none; }
  .rendered-plan h3 { font-size: 0.95rem; font-weight: 600; margin: 1.25rem 0 0.3rem; color: var(--sage); }
  .rendered-plan h4 { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--sage); margin: 1rem 0 0.5rem; }
  .rendered-plan p { margin-bottom: 0.75rem; color: #3d3d3a; }
  .rendered-plan ul, .rendered-plan ol { padding-left: 1.25rem; margin-bottom: 0.75rem; }
  .rendered-plan li { margin-bottom: 0.3rem; color: #3d3d3a; }
  .rendered-plan table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin: 0.75rem 0; }
  .rendered-plan th { background: var(--sage); color: white; padding: 0.5rem; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.04em; text-align: left; }
  .rendered-plan td { padding: 0.5rem; border-bottom: 1px solid var(--border); }
  .rendered-plan blockquote { border-left: 3px solid var(--sage); background: var(--sage-light); padding: 0.75rem 1rem; margin: 0.75rem 0; border-radius: 0 6px 6px 0; font-size: 0.85rem; }
  .rendered-plan hr { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }
  .close-btn { float: right; font-size: 0.82rem; color: var(--muted); cursor: pointer; background: none; border: none; font-family: 'DM Sans', sans-serif; }
  .plan-link-btn { display: inline-block; margin-top: 0.75rem; padding: 0.4rem 1rem; background: var(--sage); color: white; border-radius: 5px; text-decoration: none; font-size: 0.8rem; font-weight: 600; }
  .plan-link-btn:hover { background: #3a5233; }
  .badge-sim-ok { font-size: 0.72rem; font-weight: 600; background: #e8f5e9; color: #2e7d32; padding: 0.15rem 0.5rem; border-radius: 3px; }
  .badge-sim-fail { font-size: 0.72rem; font-weight: 600; background: #fce4ec; color: #c62828; padding: 0.15rem 0.5rem; border-radius: 3px; cursor: help; }
  .badge-sim-none { font-size: 0.72rem; font-weight: 600; background: var(--cream); color: var(--muted); padding: 0.15rem 0.5rem; border-radius: 3px; }
  .btn-retry { font-size: 0.72rem; color: var(--sage); font-weight: 600; cursor: pointer; text-decoration: underline; background: none; border: none; font-family: 'DM Sans', sans-serif; margin-left: 0.3rem; }
</style>
</head>
<body>

<div class="gate" id="gate">
  <h1>Scaffold Admin</h1>
  <p class="subtitle">Enter admin code to view submissions</p>
  <input type="password" id="code-input" placeholder="Admin code">
  <button onclick="login()">Enter</button>
</div>

<div id="dashboard" style="display: none;">
  <h1>Submissions <button onclick="loadSubmissions()" style="font-size:0.75rem; padding:0.3rem 0.8rem; background:var(--sage); color:white; border:none; border-radius:5px; cursor:pointer; font-family:'DM Sans',sans-serif; font-weight:600; vertical-align:middle; margin-left:0.5rem;">Refresh</button> <span style="font-size:0.82rem; font-weight:400; color:var(--muted); margin-left:0.5rem;" id="last-refreshed"></span></h1>
  <p class="subtitle" id="count"></p>
  <div class="stage-key" style="font-size:0.75rem; color:var(--muted); margin-bottom:1rem;">
    <strong>Stage key:</strong> Tier 1 processing → Tier 1 complete → Simulation processing → Simulation complete → Reconciling costs → Tier 2 processing → Tier 2 complete → Review processing → Fixing issues → Done | <span style="color:var(--error, #c94d4d);">Review failed</span>
  </div>
  <table id="table" style="display: none;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Student</th>
        <th>City</th>
        <th>Email</th>
        <th>Type</th>
        <th>Stage</th>
        <th>Submitted</th>
        <th>Plan</th>
        <th>Sim</th>
        <th>Review</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="empty" id="empty" style="display: none;">No submissions yet.</div>
  <div class="detail-panel" id="detail">
    <button class="close-btn" onclick="closeDetail()">Close</button>
    <h2 id="detail-title"></h2>
    <div class="detail-tabs">
      <button class="detail-tab active" onclick="switchTab('form')">Form Data</button>
      <button class="detail-tab" onclick="switchTab('output')">Raw Output</button>
      <button class="detail-tab" onclick="switchTab('rendered')">Rendered Plan</button>
    </div>
    <div class="tab-content active" id="tab-form">
      <div class="detail-section">
        <pre id="detail-form"></pre>
      </div>
    </div>
    <div class="tab-content" id="tab-output">
      <div class="detail-section">
        <pre id="detail-output"></pre>
      </div>
    </div>
    <div class="tab-content" id="tab-rendered">
      <div class="rendered-plan" id="detail-rendered"></div>
      <a class="plan-link-btn" id="detail-plan-link" href="#" target="_blank">Open Full Plan Page</a>
    </div>
  </div>
</div>

<script>
  let adminCode = '';

  function login() {
    adminCode = document.getElementById('code-input').value;
    loadSubmissions();
  }

  document.getElementById('code-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') login();
  });

  async function loadSubmissions() {
    try {
      const res = await fetch('/api/submissions?code=' + encodeURIComponent(adminCode));
      if (!res.ok) {
        alert('Invalid code');
        return;
      }
      const data = await res.json();
      document.getElementById('gate').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      const subs = data.submissions || [];
      document.getElementById('count').textContent = subs.length + ' submission' + (subs.length !== 1 ? 's' : '');
      document.getElementById('last-refreshed').textContent = 'Last refreshed: ' + new Date().toLocaleTimeString();

      if (subs.length === 0) {
        document.getElementById('empty').style.display = 'block';
        return;
      }

      document.getElementById('table').style.display = 'table';
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      for (const s of subs) {
        const tr = document.createElement('tr');
        const date = s.submitted_at ? new Date(s.submitted_at).toLocaleDateString() + ' ' + new Date(s.submitted_at).toLocaleTimeString() : '-';
        const type = s.payment_type || 'free';
        const typeBadge = type === 'paid' ? '<span class="badge-paid">Paid</span>' : '<span class="badge-free">Free</span>';
        const planLink = s.has_output ? `<a class="plan-link" href="plan.html?id=${s.id}" target="_blank">View Plan</a>` : '-';
        // Stage: shows current pipeline position
        let stage = s.status || 'unknown';
        let stageClass = '';
        if (stage === 'generating') { stage = 'Tier 1 processing'; stageClass = 'status-generating'; }
        else if (stage === 'tier1_complete') { stage = 'Tier 1 complete'; stageClass = 'status-generating'; }
        else if (stage === 'simulating') { stage = 'Simulation processing'; stageClass = 'status-generating'; }
        else if (stage === 'sim_complete') { stage = 'Simulation complete'; stageClass = 'status-generating'; }
        else if (stage === 'reconciling') { stage = 'Reconciling costs'; stageClass = 'status-generating'; }
        else if (stage === 'generating_tier2') { stage = 'Tier 2 processing'; stageClass = 'status-generating'; }
        else if (stage === 'tier2_complete') { stage = 'Tier 2 complete'; stageClass = 'status-generating'; }
        else if (stage === 'reviewing') { stage = 'Review processing'; stageClass = 'status-generating'; }
        else if (stage === 'fixing') { stage = 'Fixing issues'; stageClass = 'status-generating'; }
        else if (stage === 'review_failed') { stage = 'Review failed'; stageClass = 'status-failed'; }
        else if (stage === 'completed') { stage = 'Done'; stageClass = 'status-completed'; }
        const stageBadge = `<span class="${stageClass}">${stage}</span>`;
        let simBadge = '<span class="badge-sim-none">-</span>';
        if (s.has_simulation) {
          simBadge = '<span class="badge-sim-ok">OK</span>';
        } else if (s.simulation_error) {
          simBadge = '<span class="badge-sim-fail" title="' + s.simulation_error.replace(/"/g, '&quot;') + '">Failed</span><button class="btn-retry" onclick="retrySim(\'' + s.id + '\', this)">Retry</button>';
        }
        tr.innerHTML = `
          <td style="font-size:0.7rem; font-family:monospace; color:var(--muted);">${s.id}</td>
          <td><strong>${s.student_name || '-'}</strong></td>
          <td>${s.city || '-'}</td>
          <td>${s.email || '-'}</td>
          <td>${typeBadge}</td>
          <td class="stage-cell">${stageBadge}</td>
          <td>${date}</td>
          <td>${planLink}</td>
          <td>${simBadge}</td>
          <td>${s.has_review ? (s.review_status === 'PASS' ? '<span class="badge-sim-ok">PASS</span>' : '<span class="badge-sim-fail">' + (s.review_status || 'FAIL') + '</span>') : '-'}</td>
          <td><button class="btn-view" onclick="viewSubmission('${s.id}')">View</button></td>
        `;
        tbody.appendChild(tr);
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  function switchTab(tab) {
    document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector(`.detail-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
  }

  // Simple markdown to HTML for admin preview
  function mdToHtml(md) {
    // Tables
    const tableBlocks = [];
    md = md.replace(/(?:^|\n)((?:\|.+\|\n?)+)/g, (match, block) => {
      const rows = block.trim().split('\n').filter(r => r.trim());
      if (rows.length < 2) return match;
      if (!/^\|[\s\-:|]+\|$/.test(rows[1].trim())) return match;
      const headers = rows[0].split('|').filter((c,i,a) => i>0 && i<a.length-1).map(c => c.trim());
      let html = '<table><thead><tr>' + headers.map(h => '<th>'+h+'</th>').join('') + '</tr></thead><tbody>';
      rows.slice(2).forEach(row => {
        const cells = row.split('|').filter((c,i,a) => i>0 && i<a.length-1).map(c => c.trim());
        html += '<tr>' + cells.map(c => '<td>'+c.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')+'</td>').join('') + '</tr>';
      });
      html += '</tbody></table>';
      const ph = '\n<!--T'+tableBlocks.length+'-->\n';
      tableBlocks.push(html);
      return ph;
    });

    return md
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/&lt;!--T(\d+)--&gt;/g, (m,i) => tableBlocks[i])
      .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^# (.+)$/gm, '<h1>$1</h1>')
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^---+$/gm, '<hr>')
      .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
      .replace(/((?:<li>.+<\/li>\n?)+)/g, '<ul>$1</ul>')
      .replace(/^(?!<[huptlbo]|<\/|<!--)(.+)$/gm, '<p>$1</p>')
      .replace(/<p>\s*<\/p>/g, '')
      .replace(/<\/blockquote>\n<blockquote>/g, '<br>');
  }

  async function viewSubmission(id) {
    try {
      const res = await fetch('/api/submission?code=' + encodeURIComponent(adminCode) + '&id=' + id);
      const data = await res.json();

      document.getElementById('detail-title').textContent = (data.student_name || 'Unknown') + ' - ' + (data.city || '');
      document.getElementById('detail-form').textContent = JSON.stringify(data.form_data || {}, null, 2);
      document.getElementById('detail-output').textContent = data.output || '(No output yet)';

      // Render the plan (strip simulation params block)
      const rendered = document.getElementById('detail-rendered');
      if (data.output) {
        const cleanOutput = data.output.replace(/```json-simulation-params[\s\S]*?```/g, '');
        rendered.innerHTML = mdToHtml(cleanOutput);
      } else {
        rendered.innerHTML = '<p style="color:var(--muted)">No output yet.</p>';
      }

      // Set plan link
      document.getElementById('detail-plan-link').href = 'plan.html?id=' + id;

      // Reset to first tab
      switchTab('form');

      document.getElementById('detail').style.display = 'block';
      document.getElementById('detail').scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      alert('Error loading submission: ' + err.message);
    }
  }

  async function retrySim(id, btn) {
    btn.textContent = '...';
    btn.disabled = true;
    try {
      const res = await fetch('/api/simulate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id }),
      });
      if (res.ok) {
        // Replace the whole cell content
        btn.parentElement.innerHTML = '<span class="badge-sim-ok">OK</span>';
      } else {
        const err = await res.json().catch(() => ({}));
        btn.textContent = 'Retry';
        btn.disabled = false;
        alert('Simulation failed: ' + (err.error || res.status));
      }
    } catch (e) {
      btn.textContent = 'Retry';
      btn.disabled = false;
      alert('Simulation request failed: ' + e.message);
    }
  }

  function closeDetail() {
    document.getElementById('detail').style.display = 'none';
  }
</script>
</body>
</html>
