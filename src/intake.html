<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Tell us about your family. We'll build your personalized college strategy.">
<title>Build Your Plan - Scaffold</title>
<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a18;
    --cream: #f8f5f0;
    --warm-white: #fdfcfa;
    --sage: #4a6741;
    --sage-light: #e8ede6;
    --sage-dark: #3a5233;
    --terra: #c4652a;
    --terra-light: #f5ece5;
    --muted: #6b6860;
    --border: #d9d4cc;
    --error: #c94d4d;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Sans', sans-serif;
    color: var(--ink);
    background: var(--warm-white);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* ---- TOP BAR ---- */
  .topbar {
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 100;
    background: rgba(253, 252, 250, 0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .topbar-logo {
    font-family: 'Newsreader', serif;
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--ink);
    text-decoration: none;
    letter-spacing: -0.02em;
  }
  .topbar-logo span { color: var(--sage); }

  .topbar-right { display: flex; align-items: center; gap: 1.5rem; }

  .topbar-link {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.2s;
    cursor: pointer;
  }
  .topbar-link:hover { color: var(--ink); }

  .topbar-dropdown { position: relative; }
  .topbar-dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    padding-top: 0.5rem;
    min-width: 200px;
    z-index: 200;
  }
  .topbar-dropdown-menu-inner {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  .topbar-dropdown:hover .topbar-dropdown-menu { display: block; }
  .topbar-dropdown-menu-inner a {
    display: block;
    padding: 0.6rem 1rem;
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--ink);
    text-decoration: none;
    transition: background 0.15s;
  }
  .topbar-dropdown-menu-inner a:hover { background: var(--sage-light); }
  .topbar-dropdown-menu-inner a + a { border-top: 1px solid var(--border); }

  .topbar-cta {
    font-size: 0.78rem;
    font-weight: 600;
    color: white;
    background: var(--sage);
    padding: 0.35rem 0.9rem;
    border-radius: 5px;
    text-decoration: none;
    transition: background 0.2s;
  }
  .topbar-cta:hover { background: var(--sage-dark); }

  /* ---- PROGRESS BAR ---- */
  .progress-wrap {
    position: fixed;
    top: 52px;
    left: 0;
    width: 100%;
    z-index: 99;
    background: var(--cream);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 2rem;
  }

  .progress-inner {
    max-width: 640px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .progress-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--muted);
    white-space: nowrap;
  }

  .progress-track {
    flex: 1;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--sage);
    border-radius: 3px;
    transition: width 0.4s ease;
    width: 14.28%;
  }

  /* ---- FORM CONTAINER ---- */
  .form-container {
    max-width: 640px;
    margin: 0 auto;
    padding: 7.5rem 1.5rem 4rem;
  }

  /* ---- STEP ---- */
  .step { display: none; }
  .step.active { display: block; }

  .step-header {
    margin-bottom: 2rem;
  }

  .step-number {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--terra);
    margin-bottom: 0.4rem;
  }

  .step-title {
    font-family: 'Newsreader', serif;
    font-size: 1.6rem;
    font-weight: 400;
    letter-spacing: -0.02em;
    line-height: 1.2;
  }

  .step-subtitle {
    font-size: 0.88rem;
    color: var(--muted);
    margin-top: 0.5rem;
    line-height: 1.55;
  }

  /* ---- FORM FIELDS ---- */
  .field {
    margin-bottom: 1.5rem;
  }

  .field-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
  }

  .field-label {
    display: block;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--ink);
    margin-bottom: 0.35rem;
  }

  .field-label .optional {
    font-weight: 400;
    color: var(--muted);
    font-size: 0.78rem;
  }

  .field-hint {
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 0.4rem;
    line-height: 1.5;
  }

  input[type="text"],
  input[type="number"],
  input[type="email"],
  select,
  textarea {
    width: 100%;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    color: var(--ink);
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.7rem 0.85rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--sage);
    box-shadow: 0 0 0 3px rgba(74, 103, 65, 0.1);
  }

  textarea {
    resize: vertical;
    min-height: 110px;
    line-height: 1.6;
  }

  textarea.large {
    min-height: 180px;
  }

  select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b6860' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.85rem center;
    padding-right: 2.5rem;
  }

  input::placeholder,
  textarea::placeholder {
    color: #b5b0a8;
  }

  .field-error input,
  .field-error select,
  .field-error textarea {
    border-color: var(--error);
  }

  .field-error-msg {
    font-size: 0.75rem;
    color: var(--error);
    margin-top: 0.3rem;
    display: none;
  }

  .field-error .field-error-msg {
    display: block;
  }

  /* ---- CONDITIONAL FIELDS ---- */
  .conditional {
    display: none;
    margin-top: 1rem;
    padding: 1.25rem;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .conditional.visible { display: block; }
  .conditional .field:last-child { margin-bottom: 0; }

  /* ---- PRIORITY RANKING ---- */
  .priority-grid {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    counter-reset: priority;
  }

  .priority-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.7rem 0.85rem;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: grab;
    user-select: none;
    transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
    counter-increment: priority;
  }

  .priority-item:active { cursor: grabbing; }

  .priority-item.dragging {
    opacity: 0.4;
    transform: scale(0.97);
  }

  .priority-item.drag-over-above {
    box-shadow: 0 -2px 0 0 var(--sage);
    margin-top: 4px;
  }

  .priority-item.drag-over-below {
    box-shadow: 0 2px 0 0 var(--sage);
    margin-bottom: 4px;
  }

  .priority-rank {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: var(--sage-light);
    color: var(--sage-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    flex-shrink: 0;
  }

  .priority-rank::after {
    content: counter(priority);
  }

  .priority-drag-handle {
    color: var(--border);
    font-size: 1rem;
    flex-shrink: 0;
    line-height: 1;
  }

  .priority-item-label {
    font-size: 0.88rem;
    color: var(--ink);
    flex: 1;
  }

  .priority-note {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 0.5rem;
  }

  /* ---- NAVIGATION BUTTONS ---- */
  .step-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .btn-continue {
    background: var(--sage);
    color: white;
    padding: 0.85rem 2rem;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }
  .btn-continue:hover { background: var(--sage-dark); transform: translateY(-1px); }

  .btn-back {
    background: none;
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    padding: 0.85rem 1rem;
    transition: color 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }
  .btn-back:hover { color: var(--ink); }

  .btn-submit {
    background: var(--sage);
    color: white;
    padding: 0.85rem 2.5rem;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }
  .btn-submit:hover { background: var(--sage-dark); transform: translateY(-1px); }

  /* ---- CONFIRMATION SCREEN ---- */
  .confirmation {
    display: none;
    text-align: center;
    padding: 4rem 1.5rem;
  }
  .confirmation.active { display: block; }

  .confirmation-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--sage-light);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    font-size: 1.8rem;
    color: var(--sage-dark);
  }

  .confirmation h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.8rem;
    font-weight: 400;
    margin-bottom: 1rem;
  }

  .confirmation p {
    font-size: 0.95rem;
    color: var(--muted);
    max-width: 460px;
    margin: 0 auto 1rem;
    line-height: 1.65;
  }

  /* ---- ACCESS GATE ---- */
  .gate {
    display: none;
    text-align: center;
    padding: 6rem 1.5rem;
  }
  .gate.active { display: block; }

  .gate h2 {
    font-family: 'Newsreader', serif;
    font-size: 1.6rem;
    font-weight: 400;
    margin-bottom: 0.75rem;
  }

  .gate p {
    font-size: 0.92rem;
    color: var(--muted);
    max-width: 420px;
    margin: 0 auto 1.5rem;
    line-height: 1.6;
  }

  .gate a {
    display: inline-block;
    background: var(--sage);
    color: white;
    padding: 0.85rem 2rem;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    text-decoration: none;
    transition: background 0.2s;
  }
  .gate a:hover { background: var(--sage-dark); }

  .gate-divider {
    font-size: 0.8rem;
    color: var(--muted);
    margin: 1.5rem auto;
    max-width: 260px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .gate-divider::before, .gate-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .gate-code {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }
  .gate-code input {
    padding: 0.6rem 1rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: 'DM Sans', sans-serif;
    width: 180px;
  }
  .gate-code button {
    padding: 0.6rem 1.25rem;
    background: var(--ink);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
  .gate-code button:hover { opacity: 0.85; }
  .gate-code-error {
    font-size: 0.82rem;
    color: var(--error);
    margin-top: 0.5rem;
    display: none;
  }

  /* ---- SECTION DIVIDER ---- */
  .section-divider {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--sage);
    margin-top: 2rem;
    margin-bottom: 1rem;
    padding-bottom: 0.4rem;
    border-bottom: 2px solid var(--sage-light);
  }

  /* ---- PULSE ANIMATION ---- */
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* ---- STRATEGY OUTPUT ---- */
  #strategy-content h1 { font-family: 'Newsreader', serif; font-size: 1.8rem; font-weight: 500; margin-top: 2.5rem; margin-bottom: 0.5rem; letter-spacing: -0.02em; }
  #strategy-content h2 { font-family: 'Newsreader', serif; font-size: 1.4rem; font-weight: 500; margin-top: 2.5rem; margin-bottom: 0.4rem; letter-spacing: -0.02em; padding-top: 1.5rem; border-top: 1px solid var(--border); }
  #strategy-content h3 { font-size: 1.05rem; font-weight: 600; margin-top: 1.75rem; margin-bottom: 0.4rem; }
  #strategy-content h4 { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--sage); margin-top: 1.5rem; margin-bottom: 0.5rem; }
  #strategy-content p { margin-bottom: 1rem; }
  #strategy-content strong { font-weight: 600; color: var(--ink); }
  #strategy-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.82rem; }
  #strategy-content th { background: var(--cream); text-align: left; padding: 0.5rem 0.6rem; border: 1px solid var(--border); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.03em; }
  #strategy-content td { padding: 0.5rem 0.6rem; border: 1px solid var(--border); }
  #strategy-content ul, #strategy-content ol { padding-left: 1.25rem; margin-bottom: 1rem; }
  #strategy-content li { margin-bottom: 0.4rem; }
  #strategy-content hr { border: none; border-top: 2px solid var(--sage-light); margin: 2.5rem 0; }
  #strategy-content blockquote { background: var(--sage-light); border-left: 3px solid var(--sage); padding: 1rem 1.25rem; border-radius: 0 8px 8px 0; margin: 1.5rem 0; font-size: 0.88rem; color: var(--sage-dark); }

  /* ---- RESPONSIVE ---- */
  @media (max-width: 600px) {
    .field-row {
      grid-template-columns: 1fr;
      gap: 0;
    }
    .topbar-link, .topbar-dropdown { display: none; }
    .form-container { padding: 7rem 1.25rem 3rem; }
    .step-title { font-size: 1.35rem; }
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <a href="index.html" class="topbar-logo"><span>S</span>caffold</a>
  <div class="topbar-right">
    <a href="index.html" class="topbar-link">Home</a>
    <div class="topbar-dropdown">
      <a class="topbar-link topbar-dropdown-trigger">See Samples</a>
      <div class="topbar-dropdown-menu">
        <div class="topbar-dropdown-menu-inner">
          <a href="washington-sample.html">The Washington Family</a>
          <a href="medina-sample.html">The Medina Family</a>
          <a href="kaplan-sample.html">The Kaplan Family</a>
        </div>
      </div>
    </div>
    <a href="index.html#pricing" class="topbar-cta">Get Your Plan</a>
  </div>
</div>

<!-- PROGRESS BAR -->
<div class="progress-wrap">
  <div class="progress-inner">
    <span class="progress-label">Step <span id="step-current">1</span> of 7</span>
    <div class="progress-track">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
  </div>
</div>

<!-- ACCESS GATE (shown when no valid code/payment) -->
<div class="form-container">
  <div class="gate" id="gate">
    <h2>You need a plan first</h2>
    <p>Purchase your Scaffold plan on the homepage, then you'll be directed here to fill in your family's details.</p>
    <a href="index.html#pricing">Get Your Plan ($50)</a>
    <div class="gate-divider">or</div>
    <div class="gate-code">
      <input type="text" id="gate-code-input" placeholder="Enter code">
      <button onclick="tryCode()">Go</button>
    </div>
    <p class="gate-code-error" id="gate-code-error">Invalid code. Try again.</p>
  </div>

  <!-- FORM -->
  <form id="intake-form" style="display: none;" autocomplete="off">

    <!-- ======== STEP 1: About Your Student ======== -->
    <div class="step active" data-step="1">
      <div class="step-header">
        <div class="step-number">Step 1 of 7</div>
        <h2 class="step-title">About your kid</h2>
        <p class="step-subtitle">Start with the basics. We'll get to the deeper stuff next.</p>
      </div>

      <div class="field-row">
        <div class="field">
          <label class="field-label" for="student-first-name">Student's first name</label>
          <input type="text" id="student-first-name" name="student_first_name" placeholder="e.g., Alex" required>
        </div>
        <div class="field">
          <label class="field-label" for="student-last-name">Last name</label>
          <input type="text" id="student-last-name" name="student_last_name" placeholder="e.g., Smith" required>
        </div>
      </div>
      <div class="field">
        <label class="field-label" for="student-age-grade">Age and current grade</label>
        <input type="text" id="student-age-grade" name="student_age_grade" placeholder="e.g., 15 / sophomore (10th)" required>
      </div>

      <div class="field-row">
        <div class="field">
          <label class="field-label" for="school-name">School name</label>
          <input type="text" id="school-name" name="school_name" placeholder="e.g., Lincoln High School" required>
        </div>
        <div class="field">
          <label class="field-label" for="school-type">School type</label>
          <select id="school-type" name="school_type" required>
            <option value="" disabled selected>Select one</option>
            <option value="public">Public</option>
            <option value="private">Private</option>
            <option value="charter">Charter</option>
            <option value="magnet">Magnet</option>
            <option value="homeschool">Homeschool</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label class="field-label" for="school-district">School district <span class="optional">(optional)</span></label>
        <input type="text" id="school-district" name="school_district" placeholder="e.g., Fairfax County Public Schools">
      </div>

      <div class="field">
        <label class="field-label" for="academic-profile">Academic profile</label>
        <p class="field-hint">Weighted and/or unweighted GPA, any test scores (SAT, PSAT, AP exams), honors or AP courses, gifted identification, anything relevant.</p>
        <textarea id="academic-profile" name="academic_profile" placeholder="e.g., 4.2 weighted GPA (3.7 unweighted). Taking two honors classes and one AP. No SAT yet but scored well on practice PSAT. Identified for gifted program in elementary school." required></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="academic-strengths">Academic strengths</label>
        <p class="field-hint">What subjects come naturally? Where does your kid shine?</p>
        <textarea id="academic-strengths" name="academic_strengths" placeholder="e.g., Strong writer. Always gets good feedback on essays. History is his best subject by far." required></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="academic-weaknesses">Academic weaknesses or gaps</label>
        <p class="field-hint">Struggles, disinterest, or gaps. It's OK to say "nothing obvious" if that's true.</p>
        <textarea id="academic-weaknesses" name="academic_weaknesses" placeholder="e.g., Math is a slog. He does fine but it takes twice the effort. Science is average." required></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="extracurriculars">Extracurricular activities</label>
        <p class="field-hint">Sports, clubs, volunteering, jobs, anything outside the classroom. Include how long they've been doing it and any leadership roles.</p>
        <textarea id="extracurriculars" name="extracurriculars" class="large" placeholder="e.g., Varsity soccer (3 years, team captain this year). Works 10 hrs/week at a coffee shop. Volunteers at the food bank once a month. Plays piano but not competitively." required></textarea>
      </div>

      <div class="step-nav">
        <div></div>
        <button type="button" class="btn-continue" onclick="nextStep()">Continue</button>
      </div>
    </div>

    <!-- ======== STEP 2: Who They Are ======== -->
    <div class="step" data-step="2">
      <div class="step-header">
        <div class="step-number">Step 2 of 7</div>
        <h2 class="step-title">Who your kid really is</h2>
        <p class="step-subtitle">This is where the plan gets personal. The more specific you are, the better the strategy.</p>
      </div>

      <div class="field">
        <label class="field-label" for="interests">Interests, hobbies, obsessions</label>
        <p class="field-hint">What does your kid do when nobody's grading them? Include things they might not think of as "college-worthy."</p>
        <textarea id="interests" name="interests" class="large" placeholder="e.g., Plays guitar in his room for hours. Watches YouTube videos about how things are built. Reads constantly but only sci-fi. Plays pickup basketball every weekend." required></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="personality">Personality and temperament</label>
        <p class="field-hint">How would you describe your kid to a close friend? Not the resume version, the real one.</p>
        <textarea id="personality" name="personality" class="large" placeholder="e.g., Quiet in class but hilarious at home. Hates asking for help. Gets anxious before tests but once he starts he's fine. Very loyal to his friends." required></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="teacher-quote">Anything a teacher has said about your kid that stuck with you <span class="optional">(optional)</span></label>
        <p class="field-hint">A comment from a teacher, coach, or mentor that felt true.</p>
        <textarea id="teacher-quote" name="teacher_quote" placeholder='e.g., Her math teacher said she has a way of explaining things to other students that shows real understanding, not just memorization.'></textarea>
      </div>

      <div class="step-nav">
        <button type="button" class="btn-back" onclick="prevStep()">Back</button>
        <button type="button" class="btn-continue" onclick="nextStep()">Continue</button>
      </div>
    </div>

    <!-- ======== STEP 3: About the Parents ======== -->
    <div class="step" data-step="3">
      <div class="step-header">
        <div class="step-number">Step 3 of 7</div>
        <h2 class="step-title">About the parents</h2>
        <p class="step-subtitle">Our background matters for the strategy. First-gen status, professional networks, and family structure all shape the plan.</p>
      </div>

      <div class="section-divider">Parent 1</div>

      <div class="field">
        <label class="field-label" for="parent1-name">Name</label>
        <input type="text" id="parent1-name" name="parent1_name" placeholder="e.g., Lisa R." required>
      </div>

      <div class="field-row">
        <div class="field">
          <label class="field-label" for="parent1-education">Education</label>
          <input type="text" id="parent1-education" name="parent1_education" placeholder="e.g., BA from Penn State" required>
        </div>
        <div class="field">
          <label class="field-label" for="parent1-profession">Profession</label>
          <input type="text" id="parent1-profession" name="parent1_profession" placeholder="e.g., Project manager at a consulting firm" required>
        </div>
      </div>

      <div class="section-divider">Parent 2 <span class="optional">(if applicable)</span></div>

      <div class="field">
        <label class="field-label" for="parent2-name">Name <span class="optional">(optional)</span></label>
        <input type="text" id="parent2-name" name="parent2_name" placeholder="e.g., Tom R.">
      </div>

      <div class="field-row">
        <div class="field">
          <label class="field-label" for="parent2-education">Education <span class="optional">(optional)</span></label>
          <input type="text" id="parent2-education" name="parent2_education" placeholder="e.g., Some college, community college">
        </div>
        <div class="field">
          <label class="field-label" for="parent2-profession">Profession <span class="optional">(optional)</span></label>
          <input type="text" id="parent2-profession" name="parent2_profession" placeholder="e.g., Sales manager at a car dealership">
        </div>
      </div>

      <div class="section-divider">Family Structure</div>

      <div class="field">
        <label class="field-label" for="family-structure">Family structure</label>
        <select id="family-structure" name="family_structure" required>
          <option value="" disabled selected>Select one</option>
          <option value="married">Married, both in the home</option>
          <option value="divorced">Divorced or separated</option>
          <option value="single">Single parent</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="conditional" id="divorce-details">
        <div class="field">
          <label class="field-label" for="custody">Custody arrangement</label>
          <p class="field-hint">This affects financial aid forms. Some schools require the non-custodial parent's information.</p>
          <textarea id="custody" name="custody" placeholder="e.g., Primary custody with mom. Dad has every other weekend. Relationship is civil but he's not involved in school decisions."></textarea>
        </div>
        <div class="field">
          <label class="field-label" for="fafsa-parent">Which parent will file the FAFSA?</label>
          <input type="text" id="fafsa-parent" name="fafsa_parent" placeholder="e.g., Mom (primary custody)">
        </div>
        <div class="field">
          <label class="field-label" for="coparent-relationship">Relationship with co-parent regarding college planning <span class="optional">(optional)</span></label>
          <textarea id="coparent-relationship" name="coparent_relationship" placeholder="e.g., He says he'll contribute but I'm not counting on it. I need a plan that works without his money."></textarea>
        </div>
      </div>

      <div class="step-nav">
        <button type="button" class="btn-back" onclick="prevStep()">Back</button>
        <button type="button" class="btn-continue" onclick="nextStep()">Continue</button>
      </div>
    </div>

    <!-- ======== STEP 4: Siblings & Geography ======== -->
    <div class="step" data-step="4">
      <div class="step-header">
        <div class="step-number">Step 4 of 7</div>
        <h2 class="step-title">Siblings and geography</h2>
        <p class="step-subtitle">Siblings affect the financial math. Location shapes the school list.</p>
      </div>

      <div class="field">
        <label class="field-label" for="siblings">Siblings <span class="optional">(optional)</span></label>
        <p class="field-hint">Names, ages, grades, and anything relevant to the college timeline. If they'll be in college at the same time, that matters for financial aid.</p>
        <textarea id="siblings" name="siblings" placeholder="e.g., Younger sister, age 11, 5th grade. Will be applying to college in about 7 years."></textarea>
      </div>

      <div class="field-row">
        <div class="field">
          <label class="field-label" for="city">City and state</label>
          <input type="text" id="city" name="city" placeholder="e.g., Columbus, OH" required>
        </div>
        <div class="field">
          <label class="field-label" for="area-type">Area type</label>
          <select id="area-type" name="area_type" required>
            <option value="" disabled selected>Select one</option>
            <option value="urban">Urban</option>
            <option value="suburban">Suburban</option>
            <option value="rural">Rural</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label class="field-label" for="area-context">Tell us about your area <span class="optional">(optional)</span></label>
        <p class="field-hint">Is there competition to get into schools? What's your community like? What local opportunities are available?</p>
        <textarea id="area-context" name="area_context" placeholder="e.g., Very competitive school district. Lots of families hiring tutors and private counselors. Good public library system but not many internship opportunities for teens."></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="relocation">How far is your kid willing to go for college?</label>
        <textarea id="relocation" name="relocation" placeholder="e.g., East Coast preferred. Would consider Midwest for the right school. Probably not the deep South." required></textarea>
      </div>

      <div class="step-nav">
        <button type="button" class="btn-back" onclick="prevStep()">Back</button>
        <button type="button" class="btn-continue" onclick="nextStep()">Continue</button>
      </div>
    </div>

    <!-- ======== STEP 5: Finances ======== -->
    <div class="step" data-step="5">
      <div class="step-header">
        <div class="step-number">Step 5 of 7</div>
        <h2 class="step-title">Finances</h2>
        <p class="step-subtitle">This is private and it's essential. Financial aid strategy is the most valuable part of the plan, and it can't work without honest numbers.</p>
      </div>

      <div class="field-row">
        <div class="field">
          <label class="field-label" for="income">Approximate household income</label>
          <p class="field-hint">Combined annual income, pre-tax.</p>
          <input type="text" id="income" name="income" placeholder="e.g., $72,000" required>
        </div>
        <div class="field">
          <label class="field-label" for="college-budget">What can you afford per year for college? <span class="optional">(optional)</span></label>
          <p class="field-hint">Be honest. There's no wrong answer. If you're not sure, leave this blank and we'll help you figure it out.</p>
          <input type="text" id="college-budget" name="college_budget" placeholder="e.g., $10,000-15,000">
        </div>
      </div>

      <div class="field">
        <label class="field-label" for="assets">Significant assets</label>
        <p class="field-hint">Home equity, 529 plans, retirement accounts, other savings. Schools use this in financial aid formulas. Home equity especially matters for CSS Profile schools.</p>
        <textarea id="assets" name="assets" placeholder="e.g., Home worth about $950K, owe $410K. 529 plan with $62,000. Retirement accounts totaling $380K." required></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="financial-special">Any special financial circumstances <span class="optional">(optional)</span></label>
        <p class="field-hint">Business ownership, rental income, recent job change, medical expenses, anything that makes your financial picture non-standard.</p>
        <textarea id="financial-special" name="financial_special" placeholder="e.g., Nothing unusual. Both W-2 employees, straightforward taxes."></textarea>
      </div>

      <div class="step-nav">
        <button type="button" class="btn-back" onclick="prevStep()">Back</button>
        <button type="button" class="btn-continue" onclick="nextStep()">Continue</button>
      </div>
    </div>

    <!-- ======== STEP 6: School Preferences ======== -->
    <div class="step" data-step="6">
      <div class="step-header">
        <div class="step-number">Step 6 of 7</div>
        <h2 class="step-title">College preferences</h2>
        <p class="step-subtitle">Tell us what you're looking for in a college. We'll build the list, but it helps to know where your head is.</p>
      </div>

      <div class="field">
        <label class="field-label" for="size-pref">Size preference</label>
        <select id="size-pref" name="size_preference" required>
          <option value="" disabled selected>Select one</option>
          <option value="large">Large research university (15,000+)</option>
          <option value="mid">Mid-size (5,000-15,000)</option>
          <option value="small">Small liberal arts college (under 5,000)</option>
          <option value="unsure">Not sure yet</option>
        </select>
      </div>

      <div class="field">
        <label class="field-label" for="geo-pref">Geographic preference</label>
        <textarea id="geo-pref" name="geographic_preference" placeholder="e.g., East Coast preferred. Cities and suburbs feel natural. Boston, New York, Philadelphia, DC area all work." required></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="must-haves">Must-haves <span class="optional">(optional)</span></label>
        <p class="field-hint">Specific major, D1 sports, religious community, co-op programs, research opportunities, anything non-negotiable.</p>
        <textarea id="must-haves" name="must_haves" placeholder="e.g., Strong academics. Good campus life. Diverse student body. Good mentoring and advising."></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="deal-breakers">Deal-breakers <span class="optional">(optional)</span></label>
        <textarea id="deal-breakers" name="deal_breakers" placeholder="e.g., No party schools. Nothing where she'd feel academically unchallenged. No schools where $85K/year is the only option."></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="schools-radar">Schools already on your radar <span class="optional">(optional)</span></label>
        <p class="field-hint">Schools you've talked about, visited, or are curious about. No wrong answers.</p>
        <textarea id="schools-radar" name="schools_on_radar" placeholder="e.g., State flagship, maybe a couple reaches. A friend mentioned Tulane. We drove past Duke once and she liked it. No wrong answers here."></textarea>
      </div>

      <div class="step-nav">
        <button type="button" class="btn-back" onclick="prevStep()">Back</button>
        <button type="button" class="btn-continue" onclick="nextStep()">Continue</button>
      </div>
    </div>

    <!-- ======== STEP 7: Priorities & Final Thoughts ======== -->
    <div class="step" data-step="7">
      <div class="step-header">
        <div class="step-number">Step 7 of 7</div>
        <h2 class="step-title">Priorities and final thoughts</h2>
        <p class="step-subtitle">Last step. Rank what matters most, then tell us anything else.</p>
      </div>

      <div class="field">
        <label class="field-label">Drag to rank these (most important at top)</label>
        <p class="field-hint">Drag and drop to reorder. #1 is what matters most to your family.</p>
        <div class="priority-grid" id="priority-grid">
          <div class="priority-item" draggable="true" data-key="cost">
            <span class="priority-drag-handle">&#8942;&#8942;</span>
            <span class="priority-rank"></span>
            <span class="priority-item-label">Minimize total cost of attendance</span>
          </div>
          <div class="priority-item" draggable="true" data-key="prestige">
            <span class="priority-drag-handle">&#8942;&#8942;</span>
            <span class="priority-rank"></span>
            <span class="priority-item-label">Prestige / brand name</span>
          </div>
          <div class="priority-item" draggable="true" data-key="academic_fit">
            <span class="priority-drag-handle">&#8942;&#8942;</span>
            <span class="priority-rank"></span>
            <span class="priority-item-label">Academic fit (programs, research, major strength)</span>
          </div>
          <div class="priority-item" draggable="true" data-key="location">
            <span class="priority-drag-handle">&#8942;&#8942;</span>
            <span class="priority-rank"></span>
            <span class="priority-item-label">Geographic location</span>
          </div>
          <div class="priority-item" draggable="true" data-key="culture">
            <span class="priority-drag-handle">&#8942;&#8942;</span>
            <span class="priority-rank"></span>
            <span class="priority-item-label">Campus culture / social fit</span>
          </div>
          <div class="priority-item" draggable="true" data-key="merit">
            <span class="priority-drag-handle">&#8942;&#8942;</span>
            <span class="priority-rank"></span>
            <span class="priority-item-label">Merit scholarship likelihood</span>
          </div>
          <div class="priority-item" draggable="true" data-key="outcomes">
            <span class="priority-drag-handle">&#8942;&#8942;</span>
            <span class="priority-rank"></span>
            <span class="priority-item-label">Post-graduation outcomes (career, earnings, grad school)</span>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="field-label" for="priority-other">Anything else that matters to you that isn't on that list? <span class="optional">(optional)</span></label>
        <textarea id="priority-other" name="priority_other" placeholder="e.g., Diversity on campus matters to us. Also, we'd love a school with good study abroad options."></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="additional-context">Tell us anything else <span class="optional">(optional)</span></label>
        <p class="field-hint">What keeps you up at night about this? What do you wish someone would just tell you? A story about your kid that captures who they really are? The more you share, the better the plan.</p>
        <textarea id="additional-context" name="additional_context" class="large" placeholder="This is your space. There's no wrong answer and no length limit. Some families write a sentence, others write a page. Both are fine."></textarea>
      </div>

      <div class="field">
        <label class="field-label" for="email">Email address</label>
        <p class="field-hint">We'll send your completed plan to this address.</p>
        <input type="email" id="email" name="email" placeholder="you@email.com" required>
      </div>

      <div class="step-nav">
        <button type="button" class="btn-back" onclick="prevStep()">Back</button>
        <button type="button" class="btn-submit" onclick="submitForm()">Submit and Build My Plan</button>
      </div>
    </div>

  </form>

  <!-- GENERATING -->
  <div class="confirmation" id="generating">
    <div class="confirmation-icon" style="animation: pulse 2s ease infinite;">&#9998;</div>
    <h2>Building your plan...</h2>
    <p>Scaffold is generating your personalized college strategy. This takes a few minutes. Don't close this tab.</p>
    <div style="max-width: 500px; margin: 1.5rem auto;">
      <div class="progress-track" style="height: 6px;">
        <div class="progress-fill" id="gen-progress" style="width: 5%; transition: width 1s ease;"></div>
      </div>
      <p style="font-size: 0.78rem; color: var(--muted); margin-top: 0.5rem;" id="gen-status">Starting generation...</p>
    </div>
  </div>

  <!-- RESULT -->
  <div class="confirmation" id="result-screen">
    <div class="confirmation-icon">&#10003;</div>
    <h2>Your plan is ready</h2>
    <p style="margin-bottom: 2rem;">Scroll down to read your personalized Scaffold plan.</p>
  </div>

  <!-- STRATEGY OUTPUT -->
  <div id="strategy-output" style="display: none; max-width: 760px; margin: 0 auto; padding: 0 1.5rem 4rem;">
    <div id="strategy-content" style="font-size: 0.92rem; color: #3d3d3a; line-height: 1.7;"></div>
  </div>
</div>

<script>
  let currentStep = 1;
  const totalSteps = 7;
  const BYPASS_CODE = 'Millie2026';
  let paymentType = 'free';

  // Check access
  function checkAccess() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (code === BYPASS_CODE) {
      unlockForm();
      return;
    }
    // For now, show the gate. Once Stripe is wired up, we'll check payment status.
    document.getElementById('gate').classList.add('active');
    document.querySelector('.progress-wrap').style.display = 'none';
  }

  function unlockForm() {
    document.getElementById('gate').classList.remove('active');
    document.getElementById('gate').style.display = 'none';
    document.getElementById('intake-form').style.display = 'block';
    document.querySelector('.progress-wrap').style.display = 'block';
  }

  function tryCode() {
    const input = document.getElementById('gate-code-input').value.trim();
    if (input === BYPASS_CODE) {
      unlockForm();
    } else {
      document.getElementById('gate-code-error').style.display = 'block';
    }
  }

  document.getElementById('gate-code-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') tryCode();
  });

  // Step navigation
  function showStep(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.querySelector(`[data-step="${n}"]`).classList.add('active');
    document.getElementById('step-current').textContent = n;
    document.getElementById('progress-fill').style.width = ((n / totalSteps) * 100) + '%';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function nextStep() {
    // Validate current step
    const step = document.querySelector(`[data-step="${currentStep}"]`);
    const required = step.querySelectorAll('[required]');
    let valid = true;
    required.forEach(el => {
      const field = el.closest('.field') || el.closest('.priority-item');
      if (!el.value.trim()) {
        valid = false;
        if (field) field.classList.add('field-error');
      } else {
        if (field) field.classList.remove('field-error');
      }
    });

    if (!valid) return;

    if (currentStep < totalSteps) {
      currentStep++;
      showStep(currentStep);
    }
  }

  function prevStep() {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
    }
  }

  // Conditional fields: divorce details
  document.getElementById('family-structure').addEventListener('change', function() {
    const details = document.getElementById('divorce-details');
    if (this.value === 'divorced') {
      details.classList.add('visible');
    } else {
      details.classList.remove('visible');
    }
  });

  // Priority ranking: drag and drop
  const grid = document.getElementById('priority-grid');
  let dragItem = null;

  grid.addEventListener('dragstart', e => {
    dragItem = e.target.closest('.priority-item');
    if (dragItem) dragItem.classList.add('dragging');
  });

  grid.addEventListener('dragend', e => {
    const item = e.target.closest('.priority-item');
    if (item) item.classList.remove('dragging');
    clearDropIndicators();
    dragItem = null;
  });

  function clearDropIndicators() {
    grid.querySelectorAll('.priority-item').forEach(i => {
      i.classList.remove('drag-over-above', 'drag-over-below');
    });
  }

  grid.addEventListener('dragover', e => {
    e.preventDefault();
    const target = e.target.closest('.priority-item');
    if (target && target !== dragItem) {
      clearDropIndicators();
      const rect = target.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      if (e.clientY < midpoint) {
        target.classList.add('drag-over-above');
      } else {
        target.classList.add('drag-over-below');
      }
    }
  });

  grid.addEventListener('drop', e => {
    e.preventDefault();
    const target = e.target.closest('.priority-item');
    if (target && target !== dragItem && dragItem) {
      const rect = target.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      if (e.clientY < midpoint) {
        target.before(dragItem);
      } else {
        target.after(dragItem);
      }
    }
    clearDropIndicators();
  });

  // Touch support for mobile drag
  let touchItem = null;
  let touchClone = null;
  let touchStartY = 0;

  grid.addEventListener('touchstart', e => {
    const item = e.target.closest('.priority-item');
    if (!item) return;
    touchItem = item;
    touchStartY = e.touches[0].clientY;
    touchItem.style.transition = 'none';
  }, { passive: true });

  grid.addEventListener('touchmove', e => {
    if (!touchItem) return;
    e.preventDefault();
    const touchY = e.touches[0].clientY;
    const items = [...grid.querySelectorAll('.priority-item')];
    for (const item of items) {
      if (item === touchItem) continue;
      const rect = item.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      if (touchY < midY && items.indexOf(touchItem) > items.indexOf(item)) {
        item.before(touchItem);
        break;
      } else if (touchY > midY && items.indexOf(touchItem) < items.indexOf(item)) {
        item.after(touchItem);
        break;
      }
    }
  }, { passive: false });

  grid.addEventListener('touchend', () => {
    if (touchItem) touchItem.style.transition = '';
    touchItem = null;
  });

  // Stream an SSE response, calling onText for each chunk. Returns submission ID if present.
  // expectedChars: approximate character count for this tier (Tier 1 ~12000, Tier 2 ~15000)
  async function streamResponse(response, statusEl, progressEl, onText, pctStart, pctEnd, expectedChars) {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let totalChars = 0;
    let submissionId = null;
    let finished = false;

    while (!finished) {
      const { done, value } = await reader.read();
      if (done) break;

      const text = decoder.decode(value);
      const lines = text.split('\n');

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const parsed = JSON.parse(line.slice(6));
          if (parsed.id) submissionId = parsed.id;
          if (parsed.text) {
            onText(parsed.text);
            totalChars += parsed.text.length;
            // Use character count for smoother, more accurate progress
            const progress = Math.min(0.95, totalChars / expectedChars);
            const pct = pctStart + progress * (pctEnd - pctStart);
            progressEl.style.width = pct + '%';
            statusEl.textContent = 'Generating... (' + Math.round(pct) + '%)';
          }
          if (parsed.done || parsed.tier1_done) {
            progressEl.style.width = pctEnd + '%';
            finished = true;
            break;
          }
          if (parsed.error) {
            throw new Error(parsed.error);
          }
        } catch (e) {
          if (e.message && !e.message.includes('JSON')) throw e;
        }
      }
    }

    reader.cancel();
    return submissionId;
  }

  // Form submission
  async function submitForm() {
    // Prevent double-submit
    const submitBtn = document.querySelector('.btn-submit');
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    // Validate step 7
    const step = document.querySelector(`[data-step="7"]`);
    const required = step.querySelectorAll('[required]');
    let valid = true;
    required.forEach(el => {
      const field = el.closest('.field') || el.closest('.priority-item');
      if (!el.value.trim()) {
        valid = false;
        if (field) field.classList.add('field-error');
      } else {
        if (field) field.classList.remove('field-error');
      }
    });

    if (!valid) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit and Build My Plan';
      return;
    }

    // Collect all form data
    const form = document.getElementById('intake-form');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => { data[key] = value; });

    // Combine first + last name into student_name for the prompt
    data.student_name = (data.student_first_name || '') + ' ' + (data.student_last_name || '');
    data.student_name = data.student_name.trim();

    // Add priority rankings from drag order
    const priorityItems = document.querySelectorAll('#priority-grid .priority-item');
    priorityItems.forEach((item, i) => {
      data['priority_' + item.dataset.key] = i + 1;
    });

    // Track payment type
    data.payment_type = paymentType;

    // Store in localStorage as backup
    localStorage.setItem('scaffold_intake', JSON.stringify(data));
    console.log('Scaffold intake data:', JSON.stringify(data, null, 2));

    // Show generating screen
    document.getElementById('intake-form').style.display = 'none';
    document.querySelector('.progress-wrap').style.display = 'none';
    const generating = document.getElementById('generating');
    generating.classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Call the API
    try {
      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Server returned ' + response.status);
      }

      let markdown = '';
      let submissionId = null;

      const statusEl = document.getElementById('gen-status');
      const progressEl = document.getElementById('gen-progress');

      // Stream Tier 1 (Strategy Brief, ~12,000 chars)
      submissionId = await streamResponse(response, statusEl, progressEl, (text) => {
        markdown += text;
      }, 0, 45, 13000);

      // Run Monte Carlo simulation (non-blocking on failure)
      statusEl.textContent = 'Running financial simulations...';
      progressEl.style.width = '47%';
      try {
        const simRes = await fetch('/api/simulate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: submissionId }),
        });
        if (!simRes.ok) {
          const simErr = await simRes.json().catch(() => ({}));
          console.warn('Simulation returned ' + simRes.status + ':', simErr.error || 'unknown');
        }
      } catch (e) {
        console.warn('Simulation request failed:', e);
      }
      progressEl.style.width = '55%';

      statusEl.textContent = 'Building reference sections...';

      // Stream Tier 2 (Reference Sections, ~15,000 chars)
      const tier2Response = await fetch('/api/generate-tier2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: submissionId }),
      });

      if (!tier2Response.ok) {
        throw new Error('Tier 2 failed: ' + tier2Response.status);
      }

      await streamResponse(tier2Response, statusEl, progressEl, (text) => {
        markdown += text;
      }, 55, 90, 20000);

      // Quality review (non-blocking on failure)
      statusEl.textContent = 'Reviewing for accuracy...';
      progressEl.style.width = '92%';
      try {
        const reviewRes = await fetch('/api/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: submissionId }),
        });
        if (!reviewRes.ok) {
          console.warn('Review returned ' + reviewRes.status);
        }
      } catch (e) {
        console.warn('Review request failed:', e);
      }

      progressEl.style.width = '100%';
      statusEl.textContent = 'Done! Redirecting to your plan...';

      // Store the result as backup
      localStorage.setItem('scaffold_result', markdown);

      // Redirect to the styled plan page
      setTimeout(() => {
        window.location.href = 'plan.html?id=' + submissionId;
      }, 1500);

    } catch (err) {
      console.error('Generation failed:', err);
      document.getElementById('gen-status').textContent = 'Error: ' + err.message + '. Your form data is saved. Please try again.';
      document.getElementById('gen-progress').style.background = 'var(--error)';
    }
  }

  // Basic markdown to HTML
  function markdownToHtml(md) {
    let html = md
      // Escape HTML
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      // Headers
      .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^# (.+)$/gm, '<h1>$1</h1>')
      // Bold and italic
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      // Horizontal rules
      .replace(/^---+$/gm, '<hr>')
      // Tables
      .replace(/^\|(.+)\|$/gm, function(match, content) {
        const cells = content.split('|').map(c => c.trim());
        return '<tr>' + cells.map(c => {
          if (/^[-:]+$/.test(c)) return null;
          return '<td>' + c + '</td>';
        }).filter(Boolean).join('') + '</tr>';
      })
      // Blockquotes
      .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
      // Line breaks into paragraphs
      .replace(/\n\n+/g, '</p><p>')
      // Unordered lists
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      // Ordered lists
      .replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

    // Wrap consecutive <li> in <ul>
    html = html.replace(/(<li>.*?<\/li>\s*)+/g, '<ul>$&</ul>');

    // Wrap consecutive <tr> in <table>
    html = html.replace(/(<tr>.*?<\/tr>\s*)+/g, function(match) {
      // First row is header
      const rows = match.match(/<tr>.*?<\/tr>/g);
      if (rows && rows.length > 1) {
        const header = rows[0].replace(/<td>/g, '<th>').replace(/<\/td>/g, '</th>');
        const body = rows.slice(1).join('');
        // Remove separator row if it's just dashes
        const cleanBody = body.replace(/<tr>(<td>[-:]+<\/td>)+<\/tr>/g, '');
        return '<table><thead>' + header + '</thead><tbody>' + cleanBody + '</tbody></table>';
      }
      return '<table>' + match + '</table>';
    });

    // Remove empty table separator rows
    html = html.replace(/<tr>(<td>[-:]+<\/td>)+<\/tr>/g, '');

    // Wrap in paragraphs
    html = '<p>' + html + '</p>';
    // Clean up empty paragraphs
    html = html.replace(/<p>\s*<\/p>/g, '');
    // Don't wrap block elements in p
    html = html.replace(/<p>\s*(<h[1-4]|<hr|<table|<ul|<ol|<blockquote)/g, '$1');
    html = html.replace(/(<\/h[1-4]>|<\/table>|<\/ul>|<\/ol>|<\/blockquote>)\s*<\/p>/g, '$1');

    return html;
  }

  // Initialize
  checkAccess();
</script>

</body>
</html>
